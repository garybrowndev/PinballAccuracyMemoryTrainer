name: 'Security: OSSF Scorecard'

on:
  # For Branch-Protection check. Only the default branch is supported. See
  # https://github.com/ossf/scorecard/blob/main/docs/checks.md#branch-protection
  branch_protection_rule:
  # To guarantee Maintained check is occasionally updated. See
  # https://github.com/ossf/scorecard/blob/main/docs/checks.md#maintained
  schedule:
    - cron: '20 7 * * 1'
  push:
    branches: ['master']
  pull_request:
    branches: ['master']

# Declare default permissions as read only.
permissions: read-all

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  security-ossf-scorecard:
    name: 'Security: OSSF Scorecard Analysis'
    runs-on: ubuntu-latest
    permissions:
      # Needed to upload the results to code-scanning dashboard.
      security-events: write
      # Needed to publish results and get a badge (see publish_results below).
      id-token: write
      # Needed for checkout
      contents: read
      actions: read
      # Needed for PR comments
      pull-requests: write

    steps:
      - name: 'Checkout code'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          persist-credentials: false

      - name: 'Run analysis'
        uses: ossf/scorecard-action@4eaacf0543bb3f2c246792bd56e8cdeffafb205a # v2.4.3
        with:
          results_file: results.sarif
          results_format: sarif
          # PAT token with admin:read permissions to enable Branch-Protection check
          # This prevents "configuration not found" errors between master and PR branches
          repo_token: ${{ secrets.SCORECARD_TOKEN }}

          # Public repositories:
          #   - Publish results to OpenSSF REST API for easy access by consumers
          #   - Allows the repository to include the Scorecard badge.
          #   - See https://github.com/ossf/scorecard-action#publishing-results.
          # For private repositories:
          #   - `publish_results` will always be set to `false`, regardless
          #     of the value entered here.
          publish_results: true

      # Note: Branch-Protection check will not run on PRs without admin PAT token.
      # This is expected behavior - the check requires additional permissions beyond
      # the default GITHUB_TOKEN. See: https://github.com/ossf/scorecard-action/blob/main/docs/authentication/fine-grained-auth-token.md

      - name: 'Upload artifact'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: SARIF file
          path: results.sarif
          retention-days: 5

      - name: 'Upload to code-scanning'
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4
        with:
          sarif_file: results.sarif

      - name: Generate job summary
        if: always()
        run: |
          cat <<EOF > scorecard_summary.py
          import json
          import os

          print("## ðŸ›¡ï¸ OSSF Scorecard Results")

          report_path = "results.sarif"
          if os.path.exists(report_path):
              try:
                  with open(report_path, "r", encoding="utf-8") as f:
                      data = json.load(f)
                  
                  runs = data.get("runs", [])
                  if not runs:
                      print("âœ… No issues found.")
                  else:
                      results = runs[0].get("results", [])
                      if not results:
                          print("âœ… No issues found.")
                      else:
                          print(f"Found {len(results)} potential issues.")
                          print("")
                          print("| Check | Severity |")
                          print("|-------|----------|")
                          
                          counts = {}
                          for res in results:
                              rule = res.get("ruleId", "Unknown")
                              level = res.get("level", "warning")
                              key = f"{rule} ({level})"
                              counts[key] = counts.get(key, 0) + 1
                          
                          for key, count in counts.items():
                              print(f"| {key} | {count} |")
                              
              except Exception as e:
                  print(f"âš ï¸ Error parsing results: {e}")
          else:
              print("âš ï¸ Results file not found.")
          EOF

          python3 scorecard_summary.py > scorecard_summary.md
          cat scorecard_summary.md >> $GITHUB_STEP_SUMMARY

      - name: Update PR Comment
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const fs = require('fs');
            const updateComment = require('./.github/scripts/update-pr-comment.cjs');

            let body = 'Scorecard analysis failed or did not run correctly.';
            if (fs.existsSync('scorecard_summary.md')) {
              body = fs.readFileSync('scorecard_summary.md', 'utf8');
              // Remove the header
              body = body.replace(/^## .*?\n/, '');
            }

            await updateComment({
              github,
              context,
              header: 'OSSF Scorecard Results',
              body,
              workflowYaml: 'security-ossf-scorecard.yml'
            });
