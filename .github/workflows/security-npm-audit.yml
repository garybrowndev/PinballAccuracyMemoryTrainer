name: 'Security: npm Audit'

on:
  pull_request:
    branches:
      - master
    types:
      - opened
      - synchronize
      - reopened
  push:
    branches:
      - master
  schedule:
    # Run daily at 1:00 AM UTC
    - cron: '0 1 * * *'

permissions:
  contents: read

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  security-npm-audit:
    name: 'Security: npm Audit'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Security audit
        id: audit
        run: npm audit --audit-level=info --json > audit-report.json
        continue-on-error: true

      - name: Upload security audit report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: security-audit-report
          path: audit-report.json

      - name: Generate job summary
        if: always()
        run: |
          python3 -c '
          import json
          import os

          print("## ðŸ›¡ï¸ npm Audit Results")

          if os.path.exists("audit-report.json"):
              try:
                  with open("audit-report.json", "r") as f:
                      data = json.load(f)
                      metadata = data.get("metadata", {})
                      vulnerabilities = metadata.get("vulnerabilities", {})
                      total = sum(vulnerabilities.values())
                      
                      if total == 0:
                          print("\nâœ… No vulnerabilities found.")
                      else:
                          print(f"\nâš ï¸ Found {total} vulnerabilities.")
                          print("| Severity | Count |")
                          print("| --- | --- |")
                          for severity, count in vulnerabilities.items():
                              if count > 0:
                                  print(f"| {severity.title()} | {count} |")
              except Exception as e:
                  print(f"Error parsing report: {e}")
          else:
              print("Report file not found.")
          ' > npm_audit_summary.md
          cat npm_audit_summary.md >> $GITHUB_STEP_SUMMARY

      - name: Update PR Comment
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const fs = require('fs');
            const updateComment = require('./.github/scripts/update-pr-comment.cjs');

            let body = 'npm Audit failed or did not run correctly.';
            if (fs.existsSync('npm_audit_summary.md')) {
              body = fs.readFileSync('npm_audit_summary.md', 'utf8');
              // Remove the header from the body since updateComment adds it
              body = body.replace(/^## .*?\n/, '');
            }

            await updateComment({
              github,
              context,
              header: 'npm Audit Results',
              body,
              workflowYaml: 'security-npm-audit.yml'
            });

      - name: Check for failure
        if: steps.audit.outcome == 'failure'
        run: exit 1
