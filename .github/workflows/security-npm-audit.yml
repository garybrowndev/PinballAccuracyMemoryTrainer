name: 'Security: npm Audit'

on:
  pull_request:
    branches:
      - master
    types:
      - opened
      - synchronize
      - reopened
  push:
    branches:
      - master
  schedule:
    # Run daily at 1:00 AM UTC
    - cron: '0 1 * * *'

permissions:
  contents: read

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  security-npm-audit:
    name: 'Security: npm Audit'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Security audit
        id: audit
        run: npm audit --audit-level=info --json > audit-report.json
        continue-on-error: true

      - name: Upload security audit report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: security-audit-report
          path: audit-report.json

      - name: Generate job summary
        id: summary
        if: always()
        run: |
          python3 -c '
          import json
          import os
          import sys

          # Advisories that cannot be fixed without breaking changes.
          # Each entry: (ghsa_id, reason)
          ALLOWED_ADVISORIES = [
              ("GHSA-2g4f-4pwh-qvx6", "serve@14 pins ajv@8.12.0 exactly; only fix is downgrade to serve@13 (breaking). Dev-only test server, not exploitable in practice."),
          ]
          ALLOWED_GHSA = {ghsa for ghsa, _ in ALLOWED_ADVISORIES}

          print("## ðŸ›¡ï¸ npm Audit Results")

          if os.path.exists("audit-report.json"):
              try:
                  with open("audit-report.json", "r") as f:
                      data = json.load(f)

                  # Determine which vulnerability entries are covered solely by allowed advisories
                  all_vulns = data.get("vulnerabilities", {})
                  actionable = {}
                  allowed_hits = set()
                  for pkg, v in all_vulns.items():
                      via = v.get("via", [])
                      advisory_ghsas = set()
                      for item in via:
                          if isinstance(item, dict):
                              url = item.get("url", "")
                              ghsa = url.split("/")[-1] if url else ""
                              advisory_ghsas.add(ghsa)
                      if advisory_ghsas and advisory_ghsas.issubset(ALLOWED_GHSA):
                          allowed_hits.update(advisory_ghsas)
                      else:
                          actionable[pkg] = v

                  sev_order = ["critical", "high", "moderate", "low", "info"]
                  counts = {s: 0 for s in sev_order}
                  for v in actionable.values():
                      s = v.get("severity", "info")
                      counts[s] = counts.get(s, 0) + 1
                  total = sum(counts.values())

                  if total == 0:
                      print("\nâœ… No actionable vulnerabilities found.")
                  else:
                      print(f"\nâš ï¸ Found {total} actionable vulnerabilities.")
                      print("| Severity | Count |")
                      print("| --- | --- |")
                      for s in sev_order:
                          if counts[s] > 0:
                              print(f"| {s.title()} | {counts[s]} |")
                      sys.exit(1)

                  if allowed_hits:
                      print("\n### â„¹ï¸ Allowed exceptions (cannot fix without breaking changes)")
                      for ghsa, reason in ALLOWED_ADVISORIES:
                          if ghsa in allowed_hits:
                              print(f"- [{ghsa}](https://github.com/advisories/{ghsa}): {reason}")

              except SystemExit:
                  raise
              except Exception as e:
                  print(f"Error parsing report: {e}")
                  sys.exit(1)
          else:
              print("Report file not found.")
              sys.exit(1)
          ' > npm_audit_summary.md
          cat npm_audit_summary.md >> $GITHUB_STEP_SUMMARY

      - name: Update PR Comment
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const fs = require('fs');
            const updateComment = require('./.github/scripts/update-pr-comment.cjs');

            let body = 'npm Audit failed or did not run correctly.';
            if (fs.existsSync('npm_audit_summary.md')) {
              body = fs.readFileSync('npm_audit_summary.md', 'utf8');
              // Remove the header from the body since updateComment adds it
              body = body.replace(/^## .*?\n/, '');
            }

            await updateComment({
              github,
              context,
              header: 'npm Audit Results',
              body,
              workflowYaml: 'security-npm-audit.yml'
            });

      - name: Check for failure
        if: steps.audit.outcome == 'failure' && steps.summary.outcome == 'failure'
        run: exit 1
