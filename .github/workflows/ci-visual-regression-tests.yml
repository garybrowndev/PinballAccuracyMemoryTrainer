name: 'CI: Visual Regression Tests'

on:
  pull_request:
    branches:
      - master
  pull_request_review:
    types: [submitted]
  push:
    branches:
      - master

jobs:
  ci-visual-regression-tests:
    name: 'CI: Visual Regression Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: Check if Linux snapshots exist
        id: check-snapshots
        run: |
          if ls tests/e2e/visual-regression.spec.js-snapshots/*-linux.png 1> /dev/null 2>&1; then
            echo "has_snapshots=true" >> $GITHUB_OUTPUT
            echo "‚úì Linux snapshots found"
          else
            echo "has_snapshots=false" >> $GITHUB_OUTPUT
            echo "‚úó No Linux snapshots found - will generate baseline"
          fi

      - name: Run visual regression tests (comparison mode)
        if: steps.check-snapshots.outputs.has_snapshots == 'true'
        id: visual-tests
        run: |
          npx playwright test tests/e2e/visual-regression.spec.js --config config/playwright.config.js
        continue-on-error: true
        env:
          CI: true

      - name: Generate Linux baseline snapshots
        if: steps.check-snapshots.outputs.has_snapshots == 'false'
        id: generate-snapshots
        run: |
          npx playwright test tests/e2e/visual-regression.spec.js --config config/playwright.config.js --update-snapshots
          echo "snapshots_generated=true" >> $GITHUB_OUTPUT
        env:
          CI: true

      - name: Commit Linux baseline snapshots
        if: steps.generate-snapshots.outputs.snapshots_generated == 'true' && github.event_name == 'pull_request'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add tests/e2e/visual-regression.spec.js-snapshots/*-linux.png
          if git diff --staged --quiet; then
            echo "No snapshot changes to commit"
          else
            git commit -m "chore(ci): add Linux baseline snapshots for visual regression tests"
            git push
            echo "‚úì Linux baseline snapshots committed"
          fi

      - name: Fail workflow - new baselines require review
        if: steps.generate-snapshots.outputs.snapshots_generated == 'true' && github.event_name == 'pull_request'
        run: |
          echo "‚ö†Ô∏è New Linux baseline snapshots were generated and committed"
          echo ""
          echo "These snapshots have been added to the PR and require manual review."
          echo "Please review the committed snapshot files to ensure they are correct."
          echo ""
          echo "The workflow fails to ensure these baselines are not automatically merged."
          exit 1

      - name: Upload visual regression results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: visual-regression-results
          path: |
            test-results/
            playwright-report/
          retention-days: 14
          if-no-files-found: ignore

      - name: Upload baseline screenshots
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: visual-regression-snapshots
          path: tests/e2e/visual-regression.spec.js-snapshots/
          retention-days: 90
          if-no-files-found: ignore

      - name: Count visual differences
        if: steps.visual-tests.outcome == 'failure' && github.event_name == 'pull_request'
        id: count-diffs
        run: |
          DIFF_COUNT=$(find test-results -name "*-diff.png" 2>/dev/null | wc -l)
          echo "diff_count=$DIFF_COUNT" >> $GITHUB_OUTPUT
          echo "Found $DIFF_COUNT visual differences"

      - name: Request review for visual regression changes
        if: steps.visual-tests.outcome == 'failure' && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const { execSync } = require('child_process');

            // Find all diff files and extract snapshot names
            const diffFiles = execSync('find test-results -name "*-diff.png" 2>/dev/null || true', { encoding: 'utf-8' })
              .trim()
              .split('\n')
              .filter(f => f);

            // Extract the snapshot filenames that changed
            const changedSnapshots = [];
            for (const diffFile of diffFiles) {
              const baseName = path.basename(diffFile, '-diff.png');
              // The snapshot files follow pattern: test-name-browser-linux.png
              const snapshotName = `${baseName}-linux.png`;
              changedSnapshots.push(snapshotName);
            }

            // Build file links for the PR files tab
            const snapshotPath = 'tests/e2e/visual-regression.spec.js-snapshots';
            const fileLinks = changedSnapshots.map(name => {
              const fullPath = `${snapshotPath}/${name}`;
              // GitHub PR file link format uses the file path hash
              return `- [\`${name}\`](https://github.com/${context.repo.owner}/${context.repo.repo}/pull/${context.issue.number}/files#diff-${Buffer.from(fullPath).toString('hex')})`;
            }).join('\n');

            const diffCount = changedSnapshots.length;

            const body = [
              '## üì∏ Visual Regression Changes Detected',
              '',
              'Visual differences were found between the Linux baseline and current render.',
              '',
              `**${diffCount} screenshot(s) have changed:**`,
              '',
              fileLinks,
              '',
              '### Review the changes:',
              '1. Click on each file link above to see the visual differences in the PR Files tab',
              '2. If changes are intentional, **approve this review** to update the baselines',
              '3. If changes are bugs, push fixes to update the CSS/layout',
              '',
              '### To approve and update Linux baselines:',
              '**Approve this review**, then **re-run the failed workflow** to regenerate and commit the new baselines.',
              '',
              '---',
              `*ü§ñ Visual regression test completed at ${new Date().toISOString()}*`
            ].join('\n');

            // Create a review with REQUEST_CHANGES to block the PR until approved
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              body: body,
              event: 'REQUEST_CHANGES'
            });

      - name: Check for snapshot approval
        if: steps.visual-tests.outcome == 'failure' && github.event_name == 'pull_request'
        id: check-approval
        uses: actions/github-script@v8
        with:
          result-encoding: string
          script: |
            // Check if there's an approving review
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            // Look for APPROVED reviews
            const hasApproval = reviews.data.some(review => review.state === 'APPROVED');

            return hasApproval ? 'true' : 'false';

      - name: Regenerate Linux snapshots (if approved)
        if: steps.check-approval.outputs.result == 'true' && steps.visual-tests.outcome == 'failure'
        run: |
          echo "‚úì Snapshot changes approved - regenerating Linux baselines"
          npx playwright test tests/e2e/visual-regression.spec.js --config config/playwright.config.js --update-snapshots

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add tests/e2e/visual-regression.spec.js-snapshots/*-linux.png
          git commit -m "chore(ci): update Linux baseline snapshots [approved]"
          git push
        env:
          CI: true

      - name: Fail workflow - visual changes require approval
        if: steps.visual-tests.outcome == 'failure'
        run: |
          if [ "${{ steps.check-approval.outputs.result }}" == "true" ]; then
            echo "‚úì Snapshot changes were approved and updated"
            exit 0
          else
            echo "‚ùå Visual regression tests failed"
            echo ""
            echo "Visual differences detected. To proceed, you must:"
            echo "1. Review the visual changes in the PR Files tab"
            echo "2. If changes are intentional, approve the PR review"
            echo "3. The workflow will automatically re-run and update the baselines"
            echo ""
            echo "The workflow will fail until the review is approved."
            exit 1
          fi
