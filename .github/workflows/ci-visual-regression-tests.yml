name: 'CI: Visual Regression Tests'

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    branches:
      - master
  push:
    branches:
      - master

jobs:
  ci-visual-regression-tests:
    name: 'CI: Visual Regression Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: Check if Linux snapshots exist
        id: check-snapshots
        run: |
          if ls tests/e2e/visual-regression.spec.js-snapshots/*-linux.png 1> /dev/null 2>&1; then
            echo "has_snapshots=true" >> $GITHUB_OUTPUT
            echo "‚úì Linux snapshots found"
          else
            echo "has_snapshots=false" >> $GITHUB_OUTPUT
            echo "‚úó No Linux snapshots found - will generate baseline"
          fi

      - name: Run visual regression tests (comparison mode)
        if: steps.check-snapshots.outputs.has_snapshots == 'true'
        id: visual-tests
        run: |
          npx playwright test tests/e2e/visual-regression.spec.js --config config/playwright.config.js
        continue-on-error: true
        env:
          CI: true

      - name: Generate Linux baseline snapshots
        if: steps.check-snapshots.outputs.has_snapshots == 'false'
        id: generate-snapshots
        run: |
          npx playwright test tests/e2e/visual-regression.spec.js --config config/playwright.config.js --update-snapshots
          echo "snapshots_generated=true" >> $GITHUB_OUTPUT
        env:
          CI: true

      - name: Commit Linux baseline snapshots
        if: steps.generate-snapshots.outputs.snapshots_generated == 'true' && github.event_name == 'pull_request'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add tests/e2e/visual-regression.spec.js-snapshots/*-linux.png
          if git diff --staged --quiet; then
            echo "No snapshot changes to commit"
          else
            git commit -m "chore(ci): add Linux baseline snapshots for visual regression tests"
            git push
            echo "‚úì Linux baseline snapshots committed"
          fi

      - name: Fail workflow - new baselines require review
        if: steps.generate-snapshots.outputs.snapshots_generated == 'true' && github.event_name == 'pull_request'
        run: |
          echo "‚ö†Ô∏è New Linux baseline snapshots were generated and committed"
          echo ""
          echo "These snapshots have been added to the PR and require manual review."
          echo "Please review the committed snapshot files to ensure they are correct."
          echo ""
          echo "The workflow fails to ensure these baselines are not automatically merged."
          exit 1

      - name: Upload visual regression results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: visual-regression-results
          path: |
            test-results/
            playwright-report/
          retention-days: 14
          if-no-files-found: ignore

      - name: Upload baseline screenshots
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: visual-regression-snapshots
          path: tests/e2e/visual-regression.spec.js-snapshots/
          retention-days: 90
          if-no-files-found: ignore

      - name: Update snapshots with current render
        if: steps.visual-tests.outcome == 'failure' && github.event_name == 'pull_request'
        run: |
          echo "Updating snapshots to match current render for review..."
          npx playwright test tests/e2e/visual-regression.spec.js --config config/playwright.config.js --update-snapshots
        env:
          CI: true

      - name: Commit updated snapshots for review
        if: steps.visual-tests.outcome == 'failure' && github.event_name == 'pull_request'
        id: commit-snapshots
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add tests/e2e/visual-regression.spec.js-snapshots/*-linux.png
          if git diff --staged --quiet; then
            echo "No snapshot changes to commit"
            echo "new_commit_sha=" >> $GITHUB_OUTPUT
          else
            # Save list of changed files before committing
            git diff --staged --name-only | grep "\.png$" | xargs -n1 basename > /tmp/changed-snapshots.txt
            git commit -m "chore(ci): update Linux snapshots - visual changes detected [needs approval]"
            git push
            # Capture the new commit SHA for review comments
            NEW_SHA=$(git rev-parse HEAD)
            echo "new_commit_sha=$NEW_SHA" >> $GITHUB_OUTPUT
            echo "‚úì Updated snapshots committed for review (commit: $NEW_SHA)"
          fi

      - name: Request changes for visual regression review
        if: steps.visual-tests.outcome == 'failure' && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Read the list of actually changed snapshot files from git
            const changedSnapshotsContent = fs.readFileSync('/tmp/changed-snapshots.txt', 'utf-8');
            const changedSnapshots = changedSnapshotsContent.trim().split('\n').filter(f => f);

            const crypto = require('crypto');
            const snapshotPath = 'tests/e2e/visual-regression.spec.js-snapshots';
            const diffCount = changedSnapshots.length;
            const filesTabUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/pull/${context.issue.number}/files`;

            // Build main review body
            const reviewBody = [
              '## üì∏ Visual Regression Changes Detected',
              '',
              `**${diffCount} screenshot(s) have changed and require review.**`,
              '',
              '### How to review and approve:',
              '',
              `1. **[Click here to view all changed snapshots ‚Üí](${filesTabUrl})**`,
              '2. Review each changed file to ensure the visual changes are intentional',
              '3. **Click "Resolve conversation" on each file below** to approve the changes',
              '4. Once all conversations are resolved, the PR can be merged',
              '',
              '### If changes are not intentional:',
              '- Push fixes to update the CSS/layout',
              '- The workflow will automatically update snapshots on the next run',
              '',
              '---',
              `*ü§ñ Updated snapshots have been committed. Review completed at ${new Date().toISOString()}*`
            ].join('\n');

            // Create the main review with REQUEST_CHANGES
            const review = await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              body: reviewBody,
              event: 'REQUEST_CHANGES'
            });

            console.log(`Created REQUEST_CHANGES review: ${review.data.html_url}`);

            // Get the commit SHA where snapshots were just committed
            const newCommitSha = '${{ steps.commit-snapshots.outputs.new_commit_sha }}';

            if (!newCommitSha) {
              console.log('No new commit SHA available, skipping file comments');
            } else {
              console.log(`Using commit SHA for review comments: ${newCommitSha}`);
              
              // Add a review comment for each changed snapshot file
              // This creates conversations that must be resolved
              for (const fileName of changedSnapshots) {
                const fullPath = `${snapshotPath}/${fileName}`;
                const hash = crypto.createHash('sha256').update(fullPath).digest('hex');
                const fileUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/pull/${context.issue.number}/files#diff-${hash}`;
                
                const commentBody = `üì∏ **Visual changes detected in [\`${fileName}\`](${fileUrl})**\n\nPlease review this snapshot and click "Resolve conversation" if the changes are intentional.`;
                
                try {
                  // Add review comment on the file using the NEW commit SHA
                  await github.rest.pulls.createReviewComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: context.issue.number,
                    body: commentBody,
                    commit_id: newCommitSha,
                    path: fullPath,
                    line: 1,
                    side: 'RIGHT'
                  });
                  console.log(`Added review comment for ${fileName}`);
                } catch (error) {
                  console.log(`Could not add comment for ${fileName}: ${error.message}`);
                }
              }
              
              console.log(`Review complete. ${diffCount} file-specific conversations created.`);
            }

      - name: Fail workflow - visual changes require review
        if: steps.visual-tests.outcome == 'failure'
        run: |
          echo "‚ùå Visual regression tests detected changes"
          echo ""
          echo "Updated snapshots have been committed to this PR."
          echo "A review requesting changes has been posted."
          echo ""
          echo "To proceed:"
          echo "1. Review the changed snapshots in the PR Files tab"
          echo "2. Resolve each conversation if changes are intentional"
          echo "3. Once all conversations are resolved, re-run this workflow"
          echo ""
          echo "Note: Enable 'Require conversation resolution before merging' in branch"
          echo "protection settings to automatically block merging until review is complete."
          exit 1
