name: 'CI: Visual Regression Tests'

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    branches:
      - master
  push:
    branches:
      - master

jobs:
  ci-visual-regression-tests:
    name: 'CI: Visual Regression Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: Check if Linux snapshots exist
        id: check-snapshots
        run: |
          if ls tests/e2e/visual-regression.spec.js-snapshots/*-linux.png 1> /dev/null 2>&1; then
            echo "has_snapshots=true" >> $GITHUB_OUTPUT
            echo "‚úì Linux snapshots found"
          else
            echo "has_snapshots=false" >> $GITHUB_OUTPUT
            echo "‚úó No Linux snapshots found - will generate baseline"
          fi

      - name: Run visual regression tests (comparison mode)
        if: steps.check-snapshots.outputs.has_snapshots == 'true'
        id: visual-tests
        run: |
          npx playwright test tests/e2e/visual-regression.spec.js --config config/playwright.config.js
        continue-on-error: true
        env:
          CI: true

      - name: Generate Linux baseline snapshots
        if: steps.check-snapshots.outputs.has_snapshots == 'false'
        id: generate-snapshots
        run: |
          npx playwright test tests/e2e/visual-regression.spec.js --config config/playwright.config.js --update-snapshots
          echo "snapshots_generated=true" >> $GITHUB_OUTPUT
        env:
          CI: true

      - name: Commit Linux baseline snapshots
        if: steps.generate-snapshots.outputs.snapshots_generated == 'true' && github.event_name == 'pull_request'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add tests/e2e/visual-regression.spec.js-snapshots/*-linux.png
          if git diff --staged --quiet; then
            echo "No snapshot changes to commit"
          else
            git commit -m "chore(ci): add Linux baseline snapshots for visual regression tests"
            git push
            echo "‚úì Linux baseline snapshots committed"
          fi

      - name: Fail workflow - new baselines require review
        if: steps.generate-snapshots.outputs.snapshots_generated == 'true' && github.event_name == 'pull_request'
        run: |
          echo "‚ö†Ô∏è New Linux baseline snapshots were generated and committed"
          echo ""
          echo "These snapshots have been added to the PR and require manual review."
          echo "Please review the committed snapshot files to ensure they are correct."
          echo ""
          echo "The workflow fails to ensure these baselines are not automatically merged."
          exit 1

      - name: Upload visual regression results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: visual-regression-results
          path: |
            test-results/
            playwright-report/
          retention-days: 14
          if-no-files-found: ignore

      - name: Upload baseline screenshots
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: visual-regression-snapshots
          path: tests/e2e/visual-regression.spec.js-snapshots/
          retention-days: 90
          if-no-files-found: ignore

      - name: Count visual differences and extract file names
        if: steps.visual-tests.outcome == 'failure' && github.event_name == 'pull_request'
        id: count-diffs
        run: |
          # Find all actual diff files (the -diff.png files show the differences)
          # Playwright creates 3 files per failure: -actual.png, -expected.png, -diff.png
          # We only want to count the unique snapshots, not all generated files
          find test-results -name "*-diff.png" 2>/dev/null | while read diffFile; do
            # Extract just the base name to get the snapshot name
            basename "$diffFile" | sed 's/-diff\.png$//'
          done | sort -u > /tmp/diff-files.txt || true

          DIFF_COUNT=$(cat /tmp/diff-files.txt | wc -l)
          echo "diff_count=$DIFF_COUNT" >> $GITHUB_OUTPUT
          echo "Found $DIFF_COUNT unique snapshots with visual differences"

          # Show the list for debugging
          cat /tmp/diff-files.txt

      - name: Update snapshots with current render
        if: steps.visual-tests.outcome == 'failure' && github.event_name == 'pull_request'
        run: |
          echo "Updating snapshots to match current render for review..."
          npx playwright test tests/e2e/visual-regression.spec.js --config config/playwright.config.js --update-snapshots
        env:
          CI: true

      - name: Commit updated snapshots for review
        if: steps.visual-tests.outcome == 'failure' && github.event_name == 'pull_request'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add tests/e2e/visual-regression.spec.js-snapshots/*-linux.png
          if git diff --staged --quiet; then
            echo "No snapshot changes to commit"
          else
            git commit -m "chore(ci): update Linux snapshots - visual changes detected [needs approval]"
            git push
            echo "‚úì Updated snapshots committed for review"
          fi

      - name: Request review for visual regression changes
        if: steps.visual-tests.outcome == 'failure' && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Read the unique snapshot base names we saved earlier
            const diffFilesContent = fs.readFileSync('/tmp/diff-files.txt', 'utf-8');
            const baseNames = diffFilesContent.trim().split('\n').filter(f => f);

            // The base names already have the pattern: test-name-browser-linux
            // Just add .png extension to get the snapshot filename
            const changedSnapshots = baseNames.map(baseName => `${baseName}.png`);

            // Build file links for the PR files tab
            // GitHub uses SHA-256 hashes of the file path for file anchors
            const crypto = require('crypto');
            const snapshotPath = 'tests/e2e/visual-regression.spec.js-snapshots';

            const fileLinks = changedSnapshots.map(name => {
              const fullPath = `${snapshotPath}/${name}`;
              // Compute SHA-256 hash of the file path
              const hash = crypto.createHash('sha256').update(fullPath).digest('hex');
              const fileUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/pull/${context.issue.number}/files#diff-${hash}`;
              return `- [\`${name}\`](${fileUrl})`;
            }).join('\n');

            const diffCount = changedSnapshots.length;

            const filesTabUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/pull/${context.issue.number}/files`;

            const body = [
              '## üì∏ Visual Regression Changes Detected',
              '',
              'Visual differences were found between the Linux baseline and current render.',
              '',
              `**${diffCount} screenshot(s) have changed:**`,
              '',
              fileLinks,
              '',
              '### Review the changes:',
              `1. [View all changed snapshots in the Files tab ‚Üí](${filesTabUrl})`,
              '2. Updated snapshots have been committed to this PR for review',
              '3. If changes are intentional, add the label **`visual-snapshots-approved`** to this PR',
              '4. If changes are bugs, push fixes to update the CSS/layout',
              '',
              '### To approve the changes:',
              'Add the label **`visual-snapshots-approved`** to this PR and the workflow will automatically re-run and pass.',
              '',
              '---',
              `*ü§ñ Visual regression test completed at ${new Date().toISOString()}*`
            ].join('\n');

            // Create a comment review (informational)
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              body: body,
              event: 'COMMENT'
            });

      - name: Check for snapshot approval
        if: steps.visual-tests.outcome == 'failure' && github.event_name == 'pull_request'
        id: check-approval
        uses: actions/github-script@v8
        with:
          result-encoding: string
          script: |
            // Check if the PR has the approval label
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const hasApprovalLabel = labels.some(label => label.name === 'visual-snapshots-approved');

            return hasApprovalLabel ? 'true' : 'false';

      - name: Verify snapshots are approved
        if: steps.check-approval.outputs.result == 'true' && steps.visual-tests.outcome == 'failure'
        run: |
          echo "‚úì Snapshot changes have been approved"
          echo "Updated snapshots were already committed in the previous run"
          echo "Workflow will now pass"

      - name: Fail workflow - visual changes require approval
        if: steps.visual-tests.outcome == 'failure'
        run: |
          if [ "${{ steps.check-approval.outputs.result }}" == "true" ]; then
            echo "‚úì Snapshot changes were approved and updated"
            exit 0
          else
            echo "‚ùå Visual regression tests failed"
            echo ""
            echo "Visual differences detected. To proceed, you must:"
            echo "1. Review the visual changes in the PR Files tab"
            echo "2. If changes are intentional, add the label 'visual-snapshots-approved' to this PR"
            echo "3. The workflow will automatically re-run and pass"
            echo ""
            echo "The workflow will fail until the label is added."
            exit 1
          fi
