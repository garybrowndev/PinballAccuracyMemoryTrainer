name: 'CI: WebKit Browser Tests'

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

permissions:
  contents: read

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  ci-webkit-browser-tests:
    name: 'CI: WebKit Browser Tests'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build standalone for E2E testing
        run: |
          npm run build:standalone
          cp dist-standalone/pinball-trainer-standalone.html dist-standalone/index.html

      - name: Install serve package
        run: npm install -g serve@14.2.5

      - name: Install Playwright WebKit
        run: npx playwright install --with-deps webkit

      - name: Run E2E tests on WebKit (Safari)
        run: npx playwright test --project=webkit --config config/playwright.config.js --grep-invert "Visual Regression" --reporter=list,json,html
        env:
          PLAYWRIGHT_JSON_OUTPUT_FILE: results-webkit.json

      - name: Run accessibility E2E tests on WebKit
        run: npx playwright test --project=webkit --config config/playwright.config.js tests/e2e/accessibility.spec.js --reporter=list,json,html
        env:
          PLAYWRIGHT_JSON_OUTPUT_FILE: results-a11y.json

      - name: Generate job summary
        if: always()
        run: |
          python3 -c '
          import json
          import os

          def parse_json_report(file_path, title):
              if not os.path.exists(file_path):
                  return f"| {title} | âš ï¸ Not Found | - | - | - | - |"
              
              try:
                  with open(file_path, "r") as f:
                      data = json.load(f)
                  
                  stats = data.get("stats", {})
                  total = stats.get("expected", 0) + stats.get("unexpected", 0) + stats.get("flaky", 0) + stats.get("skipped", 0)
                  passed = stats.get("expected", 0)
                  failed = stats.get("unexpected", 0)
                  flaky = stats.get("flaky", 0)
                  skipped = stats.get("skipped", 0)
                  duration = round(stats.get("duration", 0) / 1000, 2)
                  
                  status = "âœ… PASS" if failed == 0 else "âŒ FAIL"
                  return f"| {title} | {status} | {total} | {passed} | {failed} | {duration}s |"
              except Exception as e:
                  return f"| {title} | âš ï¸ Error parsing | - | - | - | - |"

          print("## ðŸ§­ WebKit Browser Test Results")
          print("| Suite | Status | Total | Passed | Failed | Time |")
          print("|-------|--------|-------|--------|--------|------|")
          print(parse_json_report("results-webkit.json", "E2E Tests"))
          print(parse_json_report("results-a11y.json", "Accessibility Tests"))
          ' > webkit_summary.md
          cat webkit_summary.md >> $GITHUB_STEP_SUMMARY

      - name: Update PR Comment
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const fs = require('fs');
            const updateComment = require('./.github/scripts/update-pr-comment.cjs');

            let body = 'WebKit Browser Tests failed or did not run correctly.';
            if (fs.existsSync('webkit_summary.md')) {
              body = fs.readFileSync('webkit_summary.md', 'utf8');
              // Remove the header from the body since updateComment adds it
              body = body.replace(/^## .*?\n/, '');
            }

            await updateComment({
              github,
              context,
              header: 'WebKit Browser Test Results',
              body,
              workflowYaml: 'ci-webkit-browser-tests.yml'
            });

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: playwright-results-webkit
          path: |
            playwright-report/
            test-results/
          if-no-files-found: ignore
