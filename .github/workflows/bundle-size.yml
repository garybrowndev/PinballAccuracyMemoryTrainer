name: Bundle Size Tracking

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

jobs:
  bundle-size:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Analyze bundle size
        id: analyze
        run: |
          # Get dist folder size
          DIST_SIZE=$(du -sb dist | cut -f1)
          DIST_SIZE_MB=$(echo "scale=2; $DIST_SIZE / 1024 / 1024" | bc)

          # Get main bundle size
          MAIN_BUNDLE=$(find dist/assets -name "index-*.js" -type f -exec du -b {} \; | sort -n | tail -1 | cut -f1)
          MAIN_BUNDLE_KB=$(echo "scale=2; $MAIN_BUNDLE / 1024" | bc)

          # Get CSS bundle size
          CSS_BUNDLE=$(find dist/assets -name "index-*.css" -type f -exec du -b {} \; | sort -n | tail -1 | cut -f1)
          CSS_BUNDLE_KB=$(echo "scale=2; $CSS_BUNDLE / 1024" | bc)

          echo "dist_size_mb=$DIST_SIZE_MB" >> $GITHUB_OUTPUT
          echo "main_bundle_kb=$MAIN_BUNDLE_KB" >> $GITHUB_OUTPUT
          echo "css_bundle_kb=$CSS_BUNDLE_KB" >> $GITHUB_OUTPUT

          # Count files
          ASSET_COUNT=$(find dist/assets -type f | wc -l)
          echo "asset_count=$ASSET_COUNT" >> $GITHUB_OUTPUT

          echo "### Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total dist size | ${DIST_SIZE_MB} MB |" >> $GITHUB_STEP_SUMMARY
          echo "| Main JS bundle | ${MAIN_BUNDLE_KB} KB |" >> $GITHUB_STEP_SUMMARY
          echo "| Main CSS bundle | ${CSS_BUNDLE_KB} KB |" >> $GITHUB_STEP_SUMMARY
          echo "| Total assets | ${ASSET_COUNT} files |" >> $GITHUB_STEP_SUMMARY

      - name: Comment bundle size on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const distSize = '${{ steps.analyze.outputs.dist_size_mb }}';
            const mainBundle = '${{ steps.analyze.outputs.main_bundle_kb }}';
            const cssBundle = '${{ steps.analyze.outputs.css_bundle_kb }}';
            const assetCount = '${{ steps.analyze.outputs.asset_count }}';

            const comment = `## üì¶ Bundle Size Report

            | Metric | Size |
            |--------|------|
            | Total dist size | ${distSize} MB |
            | Main JS bundle | ${mainBundle} KB |
            | Main CSS bundle | ${cssBundle} KB |
            | Total assets | ${assetCount} files |

            ### Recommendations
            - üéØ Keep main JS bundle under 200 KB for optimal performance
            - üé® Keep CSS bundle under 50 KB
            - üìÅ Keep total dist size under 2 MB

            *Bundle analysis completed at ${new Date().toISOString()}*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Check bundle size limits
        run: |
          MAIN_BUNDLE_KB=${{ steps.analyze.outputs.main_bundle_kb }}
          CSS_BUNDLE_KB=${{ steps.analyze.outputs.css_bundle_kb }}
          DIST_SIZE_MB=${{ steps.analyze.outputs.dist_size_mb }}

          # Warning thresholds
          if (( $(echo "$MAIN_BUNDLE_KB > 200" | bc -l) )); then
            echo "‚ö†Ô∏è  Warning: Main JS bundle exceeds 200 KB ($MAIN_BUNDLE_KB KB)"
          fi

          if (( $(echo "$CSS_BUNDLE_KB > 50" | bc -l) )); then
            echo "‚ö†Ô∏è  Warning: CSS bundle exceeds 50 KB ($CSS_BUNDLE_KB KB)"
          fi

          if (( $(echo "$DIST_SIZE_MB > 2" | bc -l) )); then
            echo "‚ö†Ô∏è  Warning: Total dist size exceeds 2 MB ($DIST_SIZE_MB MB)"
          fi

          # Hard limits (fail build)
          if (( $(echo "$MAIN_BUNDLE_KB > 500" | bc -l) )); then
            echo "‚ùå Error: Main JS bundle exceeds hard limit of 500 KB ($MAIN_BUNDLE_KB KB)"
            exit 1
          fi

          echo "‚úÖ Bundle size within acceptable limits"
