name: 'CI: Lighthouse Performance Audit'

on:
  pull_request:
    branches:
      - master
    types:
      - opened
      - synchronize
      - reopened
  push:
    branches:
      - master

permissions:
  contents: read

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  ci-lighthouse-mobile:
    name: 'Lighthouse Mobile Audit'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      statuses: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Calculate version (dry-run for PR)
        id: version
        run: |
          SHORT_HASH=$(git rev-parse --short=7 HEAD)
          PR_NUMBER="${{ github.event.pull_request.number }}"
          NUMERIC_VERSION="0.0.0-PR-${PR_NUMBER}"
          FULL_VERSION="0.0.PR-${PR_NUMBER}.${SHORT_HASH}"
          echo "numeric_version=$NUMERIC_VERSION" >> $GITHUB_OUTPUT
          echo "full_version=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "commit_hash=$SHORT_HASH" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Calculated PR version: $FULL_VERSION (npm: $NUMERIC_VERSION)"

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Update package.json version for build
        run: |
          npm version ${{ steps.version.outputs.numeric_version }} --no-git-tag-version --allow-same-version

      - name: Build standalone HTML
        run: npm run build:standalone
        env:
          BUILD_COMMIT: ${{ steps.version.outputs.commit_hash }}
          BUILD_COMMIT_URL: ${{ github.server_url }}/${{ github.repository }}/commit/${{ steps.version.outputs.commit_hash }}
          BUILD_WORKFLOW_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          RELEASE_URL: 'https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}'

      - name: Run Lighthouse CI - Mobile
        id: lighthouse-mobile
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“± Running Lighthouse for Mobile..."
          xvfb-run --auto-servernum npx @lhci/cli@0.15.1 collect \
            --config=config/lighthouserc.cjs \
            --url=http://localhost:9222/pinball-trainer-standalone.html \
            --settings.emulatedFormFactor=mobile \
            --settings.throttling.rttMs=150 \
            --settings.throttling.throughputKbps=1638.4 \
            --settings.throttling.cpuSlowdownMultiplier=4 \
            --settings.screenEmulation.mobile=true \
            --settings.screenEmulation.width=412 \
            --settings.screenEmulation.height=823 \
            --settings.screenEmulation.deviceScaleFactor=2.625

          xvfb-run --auto-servernum npx @lhci/cli@0.15.1 assert --config=config/lighthouserc.cjs

          mkdir -p lighthouseci-mobile-reports
          cp -r .lighthouseci/. lighthouseci-mobile-reports/

          echo "=== Mobile Upload Debug Info ==="
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "PR: ${{ github.event.pull_request.number }}"

          UPLOAD_OUTPUT=$(npx @lhci/cli@0.15.1 upload --config=config/lighthouserc.cjs 2>&1)
          echo "$UPLOAD_OUTPUT"

          # Extract URLs - comparison URL takes precedence, then direct URL
          MOBILE_COMPARE_URL=$(echo "$UPLOAD_OUTPUT" | grep -oP 'https://googlechrome\.github\.io/lighthouse-ci/viewer/\?[^"]*' | head -n 1 || echo "")

          # If we have a comparison URL, extract the direct URLs from its parameters
          if [ -n "$MOBILE_COMPARE_URL" ]; then
            # URL decode and extract baseReport and compareReport URLs
            MOBILE_BASE_URL=$(echo "$MOBILE_COMPARE_URL" | sed 's/.*baseReport=\([^&]*\).*/\1/' | sed 's/%3A/:/g; s/%2F/\//g' || echo "")
            MOBILE_COMPARE_DIRECT_URL=$(echo "$MOBILE_COMPARE_URL" | sed 's/.*compareReport=\([^&]*\).*/\1/' | sed 's/%3A/:/g; s/%2F/\//g' || echo "")
            # Use the compare report as the primary direct URL
            MOBILE_DIRECT_URL="$MOBILE_COMPARE_DIRECT_URL"
            MOBILE_REPORT_URL="$MOBILE_COMPARE_URL"
          else
            # No comparison URL available, use direct URL for both
            MOBILE_DIRECT_URL=$(echo "$UPLOAD_OUTPUT" | grep -oP 'https://storage\.googleapis\.com/[^\s]+\.report\.html' | head -n 1 || echo "")
            MOBILE_REPORT_URL="$MOBILE_DIRECT_URL"
          fi

          echo "MOBILE_REPORT_URL=$MOBILE_REPORT_URL" >> $GITHUB_ENV
          echo "MOBILE_DIRECT_URL=$MOBILE_DIRECT_URL" >> $GITHUB_ENV

      - name: Upload Mobile Lighthouse Reports
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: lighthouse-mobile-reports
          path: lighthouseci-mobile-reports
          retention-days: 30
          if-no-files-found: warn

      - name: Generate mobile summary
        if: always()
        env:
          MOBILE_URL: ${{ env.MOBILE_REPORT_URL }}
          MOBILE_DIRECT_URL: ${{ env.MOBILE_DIRECT_URL }}
        run: |
          python3 -c '
          import json
          import glob
          import os

          print("## ðŸ“± Lighthouse Mobile Results\n")

          mobile_url = os.environ.get("MOBILE_URL", "")
          mobile_direct_url = os.environ.get("MOBILE_DIRECT_URL", "")

          if mobile_url and mobile_direct_url and mobile_url != mobile_direct_url:
              print(f"**[View Comparison Report]({mobile_url})** | **[View Direct Report]({mobile_direct_url})**\n")
          elif mobile_url:
              print(f"**[View Report]({mobile_url})**\n")

          files = glob.glob("lighthouseci-mobile-reports/lhr-*.json")
          if not files:
              print("No Lighthouse reports found.")
          else:
              scores = {"performance": [], "accessibility": [], "best-practices": [], "seo": []}
              
              for f in files:
                  try:
                      with open(f, "r") as json_file:
                          data = json.load(json_file)
                          categories = data.get("categories", {})
                          
                          for key in scores.keys():
                              if key in categories:
                                  scores[key].append(categories[key].get("score", 0))
                  except Exception as e:
                      print(f"âš ï¸ Error processing {f}: {e}")
              
              print("\n| Category | Score |")
              print("| --- | --- |")
              for key, score_list in scores.items():
                  if score_list:
                      avg_score = (sum(score_list) / len(score_list)) * 100
                      emoji = "ðŸŸ¢" if avg_score >= 90 else "ðŸŸ " if avg_score >= 50 else "ðŸ”´"
                      category_name = key.replace("-", " ").title()
                      print(f"| {category_name} | {emoji} {avg_score:.0f} |")

          print("\n_See artifacts for detailed reports._")
          ' > lighthouse_mobile_summary.md
          cat lighthouse_mobile_summary.md >> $GITHUB_STEP_SUMMARY

  ci-lighthouse-desktop:
    name: 'Lighthouse Desktop Audit'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      statuses: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Calculate version (dry-run for PR)
        id: version
        run: |
          SHORT_HASH=$(git rev-parse --short=7 HEAD)
          PR_NUMBER="${{ github.event.pull_request.number }}"
          NUMERIC_VERSION="0.0.0-PR-${PR_NUMBER}"
          FULL_VERSION="0.0.PR-${PR_NUMBER}.${SHORT_HASH}"
          echo "numeric_version=$NUMERIC_VERSION" >> $GITHUB_OUTPUT
          echo "full_version=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "commit_hash=$SHORT_HASH" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Calculated PR version: $FULL_VERSION (npm: $NUMERIC_VERSION)"

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Update package.json version for build
        run: |
          npm version ${{ steps.version.outputs.numeric_version }} --no-git-tag-version --allow-same-version

      - name: Build standalone HTML
        run: npm run build:standalone
        env:
          BUILD_COMMIT: ${{ steps.version.outputs.commit_hash }}
          BUILD_COMMIT_URL: ${{ github.server_url }}/${{ github.repository }}/commit/${{ steps.version.outputs.commit_hash }}
          BUILD_WORKFLOW_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          RELEASE_URL: 'https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}'

      - name: Run Lighthouse CI - Desktop
        id: lighthouse-desktop
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ–¥ï¸  Running Lighthouse for Desktop..."
          xvfb-run --auto-servernum npx @lhci/cli@0.15.1 collect \
            --config=config/lighthouserc.cjs \
            --url=http://localhost:9222/pinball-trainer-standalone-desktop.html \
            --settings.emulatedFormFactor=desktop \
            --settings.throttling.rttMs=40 \
            --settings.throttling.throughputKbps=10240 \
            --settings.throttling.cpuSlowdownMultiplier=1 \
            --settings.screenEmulation.mobile=false \
            --settings.screenEmulation.width=1350 \
            --settings.screenEmulation.height=940 \
            --settings.screenEmulation.deviceScaleFactor=1

          xvfb-run --auto-servernum npx @lhci/cli@0.15.1 assert --config=config/lighthouserc.cjs

          mkdir -p lighthouseci-desktop-reports
          cp -r .lighthouseci/. lighthouseci-desktop-reports/

          echo "=== Desktop Upload Debug Info ==="
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "PR: ${{ github.event.pull_request.number }}"

          UPLOAD_OUTPUT=$(npx @lhci/cli@0.15.1 upload --config=config/lighthouserc.cjs 2>&1)
          echo "$UPLOAD_OUTPUT"

          # Extract URLs - comparison URL takes precedence, then direct URL
          DESKTOP_COMPARE_URL=$(echo "$UPLOAD_OUTPUT" | grep -oP 'https://googlechrome\.github\.io/lighthouse-ci/viewer/\?[^"]*' | head -n 1 || echo "")

          # If we have a comparison URL, extract the direct URLs from its parameters
          if [ -n "$DESKTOP_COMPARE_URL" ]; then
            # URL decode and extract baseReport and compareReport URLs
            DESKTOP_BASE_URL=$(echo "$DESKTOP_COMPARE_URL" | sed 's/.*baseReport=\([^&]*\).*/\1/' | sed 's/%3A/:/g; s/%2F/\//g' || echo "")
            DESKTOP_COMPARE_DIRECT_URL=$(echo "$DESKTOP_COMPARE_URL" | sed 's/.*compareReport=\([^&]*\).*/\1/' | sed 's/%3A/:/g; s/%2F/\//g' || echo "")
            # Use the compare report as the primary direct URL
            DESKTOP_DIRECT_URL="$DESKTOP_COMPARE_DIRECT_URL"
            DESKTOP_REPORT_URL="$DESKTOP_COMPARE_URL"
          else
            # No comparison URL available, use direct URL for both
            DESKTOP_DIRECT_URL=$(echo "$UPLOAD_OUTPUT" | grep -oP 'https://storage\.googleapis\.com/[^\s]+\.report\.html' | head -n 1 || echo "")
            DESKTOP_REPORT_URL="$DESKTOP_DIRECT_URL"
          fi

          echo "DESKTOP_REPORT_URL=$DESKTOP_REPORT_URL" >> $GITHUB_ENV
          echo "DESKTOP_DIRECT_URL=$DESKTOP_DIRECT_URL" >> $GITHUB_ENV

      - name: Upload Desktop Lighthouse Reports
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: lighthouse-desktop-reports
          path: lighthouseci-desktop-reports
          retention-days: 30
          if-no-files-found: warn

      - name: Generate desktop summary
        if: always()
        env:
          DESKTOP_URL: ${{ env.DESKTOP_REPORT_URL }}
          DESKTOP_DIRECT_URL: ${{ env.DESKTOP_DIRECT_URL }}
        run: |
          python3 -c '
          import json
          import glob
          import os

          print("## ðŸ–¥ï¸ Lighthouse Desktop Results\n")

          desktop_url = os.environ.get("DESKTOP_URL", "")
          desktop_direct_url = os.environ.get("DESKTOP_DIRECT_URL", "")

          if desktop_url and desktop_direct_url and desktop_url != desktop_direct_url:
              print(f"**[View Comparison Report]({desktop_url})** | **[View Direct Report]({desktop_direct_url})**\n")
          elif desktop_url:
              print(f"**[View Report]({desktop_url})**\n")

          files = glob.glob("lighthouseci-desktop-reports/lhr-*.json")
          if not files:
              print("No Lighthouse reports found.")
          else:
              scores = {"performance": [], "accessibility": [], "best-practices": [], "seo": []}
              
              for f in files:
                  try:
                      with open(f, "r") as json_file:
                          data = json.load(json_file)
                          categories = data.get("categories", {})
                          
                          for key in scores.keys():
                              if key in categories:
                                  scores[key].append(categories[key].get("score", 0))
                  except Exception as e:
                      print(f"âš ï¸ Error processing {f}: {e}")
              
              print("\n| Category | Score |")
              print("| --- | --- |")
              for key, score_list in scores.items():
                  if score_list:
                      avg_score = (sum(score_list) / len(score_list)) * 100
                      emoji = "ðŸŸ¢" if avg_score >= 90 else "ðŸŸ " if avg_score >= 50 else "ðŸ”´"
                      category_name = key.replace("-", " ").title()
                      print(f"| {category_name} | {emoji} {avg_score:.0f} |")

          print("\n_See artifacts for detailed reports._")
          ' > lighthouse_desktop_summary.md
          cat lighthouse_desktop_summary.md >> $GITHUB_STEP_SUMMARY

  combine-pr-comments:
    name: 'Update PR Comment'
    runs-on: ubuntu-latest
    needs: [ci-lighthouse-mobile, ci-lighthouse-desktop]
    if: always() && github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Update PR Comment
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const updateComment = require('./.github/scripts/update-pr-comment.cjs');

            const body = 'âœ… Lighthouse audits completed. Check the job summaries for detailed results.';

            await updateComment({
              github,
              context,
              header: 'Lighthouse CI Results',
              body,
              workflowYaml: 'ci-lighthouse.yml'
            });
