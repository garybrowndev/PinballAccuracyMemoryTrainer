# Auto-label PRs based on files changed
# https://github.com/actions/labeler

name: 'Automation: Label Pull Request'

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

permissions:
  contents: read
  pull-requests: write

jobs:
  automation-label-pull-request:
    name: 'Automation: Label Pull Request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Apply labels based on changed files
        uses: actions/labeler@634933edcd8ababfe52f92936142cc22ac488b1b # v6.0.1
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          sync-labels: false # Only add labels, don't remove existing ones

      - name: Generate job summary
        if: always()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const updateComment = require('./.github/scripts/update-pr-comment.cjs');
            const { owner, repo } = context.repo;
            const prNumber = context.issue.number;

            try {
              const { data: pr } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: prNumber
              });
              
              const labels = pr.labels.map(l => l.name);
              const prUrl = pr.html_url;
              
              let summary = `## ðŸ·ï¸ Pull Request Labeler\n\n`;
              summary += `**PR:** [${pr.title} (#${prNumber})](${prUrl})\n\n`;
              
              let body = `**PR:** [${pr.title} (#${prNumber})](${prUrl})\n\n`;

              if (labels.length > 0) {
                summary += `### Current Labels\n`;
                body += `### Current Labels\n`;
                labels.forEach(label => {
                  summary += `- \`${label}\`\n`;
                  body += `- \`${label}\`\n`;
                });
              } else {
                summary += `No labels applied.\n`;
                body += `No labels applied.\n`;
              }
              
              core.summary.addRaw(summary).write();

              await updateComment({
                github,
                context,
                header: 'Pull Request Labeler',
                body,
                workflowYaml: 'automation-label-pull-request.yml'
              });
            } catch (error) {
              core.setFailed(`Failed to get PR details: ${error.message}`);
            }
