name: 'CD: Release'

on:
  push:
    branches:
      - master

permissions:
  contents: read

# Prevent multiple concurrent releases - only one at a time
concurrency:
  group: cd-release-${{ github.sha }}
  cancel-in-progress: false

jobs:
  cd-release-build:
    name: 'CD: Build and Deploy Release'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      security-events: write
      statuses: write

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Calculate version from commit count and timestamp
        id: version
        run: |
          # Get commit count on master branch
          COMMIT_COUNT=$(git rev-list --count HEAD)

          # Get timestamp (YYYYMMDD.HHMM format)
          TIMESTAMP=$(date -u +"%Y%m%d.%H%M")

          # Get short commit hash (7 chars) for reference
          SHORT_HASH=$(git rev-parse --short=7 HEAD)

          # Major.Minor.CommitCount.YYYYMMDD.HHMM
          FULL_VERSION="0.0.${COMMIT_COUNT}.${TIMESTAMP}"

          # Numeric version for npm (semver compliant): 0.0.{commit_count}
          NUMERIC_VERSION="0.0.${COMMIT_COUNT}"

          echo "numeric_version=$NUMERIC_VERSION" >> $GITHUB_OUTPUT
          echo "full_version=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "commit_hash=$SHORT_HASH" >> $GITHUB_OUTPUT
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "üì¶ Calculated version: $FULL_VERSION (npm: $NUMERIC_VERSION, commit: $SHORT_HASH)"

      - name: Check if tag already exists
        id: check_tag
        run: |
          if git rev-parse "v${{ steps.version.outputs.full_version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Tag v${{ steps.version.outputs.full_version }} already exists - skipping release"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Tag v${{ steps.version.outputs.full_version }} does not exist - proceeding with release"
          fi

      - name: Create and push tag
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          NEW_VERSION="${{ steps.version.outputs.full_version }}"
          git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION"
          git push origin "v$NEW_VERSION"
          echo "üè∑Ô∏è  Created and pushed tag v$NEW_VERSION"

      - name: Wait for all other workflows to complete
        if: steps.check_tag.outputs.exists == 'false'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const headSha = context.sha;
            const currentWorkflow = 'CD: Release';
            console.log(`Waiting for all workflows on commit ${headSha} to complete...`);

            const maxAttempts = 60; // 30 minutes max (60 attempts * 30 seconds)
            let attempt = 0;

            while (attempt < maxAttempts) {
              attempt++;
              console.log(`\nüîÑ Attempt ${attempt}/${maxAttempts}`);
              
              // Get all workflow runs for this commit
              const runs = await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head_sha: headSha,
                per_page: 100
              });
              
              // Filter out this workflow and check others
              const otherWorkflows = runs.data.workflow_runs.filter(run => 
                run.name !== currentWorkflow && run.event === 'push'
              );
              
              console.log(`Found ${otherWorkflows.length} other workflows`);
              
              let allComplete = true;
              let allSuccess = true;
              const results = {};
              
              for (const run of otherWorkflows) {
                const status = run.status === 'completed' ? run.conclusion : run.status;
                results[run.name] = status;
                
                if (run.status !== 'completed') {
                  allComplete = false;
                  console.log(`‚è≥ ${run.name}: ${run.status}`);
                } else {
                  // Fail fast if any workflow failed or was skipped
                  if (run.conclusion !== 'success') {
                    throw new Error(`Workflow ${run.name} failed with conclusion: ${run.conclusion}. Aborting deployment.`);
                  }
                  console.log(`‚úÖ ${run.name}: success`);
                }
              }
              
              if (allComplete) {
                console.log('\nüìä All workflows completed!');
                console.log(JSON.stringify(results, null, 2));
                
                if (!allSuccess) {
                  throw new Error('One or more workflows failed. Aborting deployment.');
                }
                
                console.log('\n‚úÖ All workflows succeeded! Proceeding with deployment.');
                break;
              }
              
              if (attempt < maxAttempts) {
                console.log(`\n‚è∞ Waiting 30 seconds before checking again...`);
                await new Promise(resolve => setTimeout(resolve, 30000));
              }
            }

            if (attempt >= maxAttempts) {
              throw new Error('Timeout waiting for workflows to complete after 30 minutes');
            }

      - name: Setup Node.js for build
        if: steps.check_tag.outputs.exists == 'false'
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        if: steps.check_tag.outputs.exists == 'false'
        run: npm ci

      - name: Build standalone HTML
        if: steps.check_tag.outputs.exists == 'false'
        run: npm run build:standalone
        env:
          APP_VERSION: ${{ steps.version.outputs.full_version }}
          BUILD_COMMIT: ${{ steps.version.outputs.commit_hash }}
          BUILD_COMMIT_URL: ${{ github.server_url }}/${{ github.repository }}/commit/${{ steps.version.outputs.commit_hash }}
          BUILD_WORKFLOW_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          RELEASE_URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.full_version }}

      - name: Prepare GitHub Pages deployment structure
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          # Create a temporary directory for GitHub Pages
          mkdir -p gh-pages-deploy

          # Copy standalone build to root (latest version) and rename to index.html
          cp dist-standalone/pinball-trainer-standalone.html gh-pages-deploy/index.html

          # Copy screenshot to root for README display
          cp public/images/app-screenshot.webp gh-pages-deploy/app-screenshot.webp

          # Copy standalone build to versioned release directory (keep original name)
          mkdir -p gh-pages-deploy/releases/${{ steps.version.outputs.full_version }}
          cp -r dist-standalone/* gh-pages-deploy/releases/${{ steps.version.outputs.full_version }}/

          echo "üì¶ Prepared deployment structure:"
          ls -la gh-pages-deploy/
          echo "üì¶ Versioned release:"
          ls -la gh-pages-deploy/releases/${{ steps.version.outputs.full_version }}/

      - name: Deploy to GitHub Pages
        if: steps.check_tag.outputs.exists == 'false'
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e # v4.0.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-deploy
          keep_files: true

      - name: Wait for GitHub Pages deployment to propagate
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          echo "‚è≥ Waiting 60 seconds for GitHub Pages to update..."
          sleep 60

      - name: Validate GitHub Pages deployment
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          SITE_URL="https://garybrowndev.github.io/PinballAccuracyMemoryTrainer/"
          echo "üîç Validating deployment at $SITE_URL"

          # Fetch the page
          HTTP_CODE=$(curl -s -o /tmp/gh-pages.html -w "%{http_code}" "$SITE_URL")

          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå ERROR: Site returned HTTP $HTTP_CODE instead of 200"
            exit 1
          fi

          echo "‚úÖ Site returned HTTP 200"

          # Check for actual 404 error page (in title or heading, not in JavaScript code)
          if grep -E "<title>[^<]*404[^<]*</title>" /tmp/gh-pages.html > /dev/null || grep -E "<h[1-6][^>]*>[^<]*404.*Not Found[^<]*</h[1-6]>" /tmp/gh-pages.html > /dev/null; then
            echo "‚ùå ERROR: Page appears to be a 404 error page"
            head -n 50 /tmp/gh-pages.html
            exit 1
          fi

          # Check for external script references that might 404
          EXTERNAL_SCRIPTS=$(grep -o 'src="[^"]*\.js"' /tmp/gh-pages.html || true)
          if [ ! -z "$EXTERNAL_SCRIPTS" ]; then
            echo "‚ö†Ô∏è  WARNING: Found external script references in standalone HTML:"
            echo "$EXTERNAL_SCRIPTS"
            echo "‚ùå ERROR: Standalone build should not have external script references"
            exit 1
          fi

          # Check for external CSS references
          EXTERNAL_CSS=$(grep -o 'href="[^"]*\.css"' /tmp/gh-pages.html || true)
          if [ ! -z "$EXTERNAL_CSS" ]; then
            echo "‚ö†Ô∏è  WARNING: Found external CSS references in standalone HTML:"
            echo "$EXTERNAL_CSS"
            echo "‚ùå ERROR: Standalone build should not have external CSS references"
            exit 1
          fi

          # Check that there's actually some content
          FILE_SIZE=$(wc -c < /tmp/gh-pages.html)
          if [ "$FILE_SIZE" -lt 100000 ]; then
            echo "‚ùå ERROR: Page size is suspiciously small ($FILE_SIZE bytes)"
            echo "Expected at least 100KB for standalone HTML with embedded assets"
            exit 1
          fi

          echo "‚úÖ Page size: $FILE_SIZE bytes"
          echo "‚úÖ No external script/CSS references found"
          echo "‚úÖ GitHub Pages deployment validated successfully!"

      - name: Get previous release tag
        if: steps.check_tag.outputs.exists == 'false'
        id: previous_release
        run: |
          # Get the most recent tag before the current one
          PREVIOUS_TAG=$(git tag --sort=-version:refname | head -n 1)
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          echo "üìã Previous release tag: $PREVIOUS_TAG"

      - name: Create Release
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: v${{ steps.version.outputs.full_version }}
          name: Release ${{ steps.version.outputs.full_version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          make_latest: true
          files: |
            dist-standalone/pinball-trainer-standalone.html
          body: |
            ## Pinball Accuracy Memory Trainer v${{ steps.version.outputs.full_version }}

            A specialized memory training tool for pinball players to practice and improve flipper shot accuracy recall.

            ### üöÄ Try it Online

            **[Launch Latest Version ‚Üí](https://garybrowndev.github.io/PinballAccuracyMemoryTrainer/)**

            **[Launch This Release (v${{ steps.version.outputs.full_version }}) ‚Üí](https://garybrowndev.github.io/PinballAccuracyMemoryTrainer/releases/${{ steps.version.outputs.full_version }}/pinball-trainer-standalone.html)**

            ### üíæ Or Download

            Download the standalone HTML file below and open it in your browser. No installation or internet connection required - all assets are embedded.

            ### What's Included

            - 39 preset pinball tables (Addams Family, Medieval Madness, Attack from Mars, and more)
            - Progressive training with drift mechanics
            - Visual playfield editor
            - Performance tracking and feedback
            - Fully offline-capable

            ### Usage

            1. Click the "Launch Latest Version" link above to use the most recent version, OR
            2. Click the "Launch This Release" link to use this specific version, OR
            3. Download `pinball-trainer-standalone.html` below
            4. Open the downloaded file in any modern browser
            5. Start training!
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate job summary
        if: always()
        run: |
          echo "## üöÄ Release Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          VERSION="${{ steps.version.outputs.full_version }}"
          TAG_EXISTS="${{ steps.check_tag.outputs.exists }}"

          if [ "$TAG_EXISTS" == "true" ]; then
            echo "‚ÑπÔ∏è **Release Skipped**: Tag v$VERSION already exists." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **Release Created**: v$VERSION" >> $GITHUB_STEP_SUMMARY
            echo "üîó [View Release](${{ github.server_url }}/${{ github.repository }}/releases/tag/v$VERSION)" >> $GITHUB_STEP_SUMMARY
            echo "üîó [Open App](https://garybrowndev.github.io/PinballAccuracyMemoryTrainer/)" >> $GITHUB_STEP_SUMMARY
          fi
