name: 'CD: Release'

on:
  workflow_run:
    workflows:
      - 'CI: Chromium Browser Tests'
      - 'CI: Firefox Browser Tests'
      - 'CI: WebKit Browser Tests'
      - 'Security: CodeQL Security Analysis'
      - 'CI: Visual Regression Tests'
    types:
      - completed
    branches:
      - master

# Prevent multiple concurrent releases - only one at a time per branch
concurrency:
  group: cd-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  cd-release-check:
    name: 'CD: Release Check'
    runs-on: ubuntu-latest
    # Only proceed if the triggering workflow succeeded
    # NOTE: This workflow runs 5 times per push to master (once per completing workflow).
    # The concurrency group above ensures only one release runs at a time - others are queued.
    # Each queued run will check if all 5 workflows succeeded before proceeding.
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      all_success: ${{ steps.check.outputs.all_success }}
    steps:
      - name: Check all required workflows succeeded
        id: check
        uses: actions/github-script@v8
        with:
          script: |
            const requiredWorkflows = [
              'CI: Chromium Browser Tests',
              'CI: Firefox Browser Tests',
              'CI: WebKit Browser Tests',
              'Security: CodeQL Security Analysis',
              'CI: Visual Regression Tests'
            ];

            const headSha = context.payload.workflow_run.head_sha;
            console.log(`Checking workflows for commit: ${headSha}`);

            let allSuccess = true;
            const results = {};

            for (const workflowName of requiredWorkflows) {
              console.log(`\nðŸ” Checking: ${workflowName}`);

              // Get all workflow runs for this commit
              const runs = await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head_sha: headSha,
                per_page: 100
              });

              // Find the workflow run for this specific workflow
              const workflowRun = runs.data.workflow_runs.find(run => run.name === workflowName);

              if (!workflowRun) {
                console.log(`âŒ ${workflowName}: Not found or not started`);
                allSuccess = false;
                results[workflowName] = 'not_found';
                continue;
              }

              if (workflowRun.status !== 'completed') {
                console.log(`â³ ${workflowName}: Still running (${workflowRun.status})`);
                allSuccess = false;
                results[workflowName] = workflowRun.status;
                continue;
              }

              if (workflowRun.conclusion !== 'success') {
                console.log(`âŒ ${workflowName}: Failed with conclusion: ${workflowRun.conclusion}`);
                allSuccess = false;
                results[workflowName] = workflowRun.conclusion;
                continue;
              }

              console.log(`âœ… ${workflowName}: Success`);
              results[workflowName] = 'success';
            }

            console.log('\nðŸ“Š Summary:');
            console.log(JSON.stringify(results, null, 2));

            if (allSuccess) {
              console.log('\nâœ… All required workflows succeeded! Proceeding with release.');
            } else {
              console.log('\nâ¸ï¸  Not all workflows completed successfully yet. Skipping release.');
            }

            core.setOutput('all_success', allSuccess);
            return allSuccess;

  cd-release-deploy:
    name: 'CD: Release Deploy'
    needs: cd-release-check
    if: ${{ needs.cd-release-check.outputs.all_success == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      security-events: write
      statuses: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Calculate version from run number and commit hash
        id: version
        run: |
          # Get short commit hash (7 chars)
          SHORT_HASH=$(git rev-parse --short=7 HEAD)
          # Numeric version for npm (semver compliant): 0.0.{run_number}
          NUMERIC_VERSION="0.0.${{ github.run_number }}"
          # Full version with commit hash for tag: 0.0.{run_number}.{hash}
          FULL_VERSION="0.0.${{ github.run_number }}.${SHORT_HASH}"
          echo "numeric_version=$NUMERIC_VERSION" >> $GITHUB_OUTPUT
          echo "full_version=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "commit_hash=$SHORT_HASH" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Calculated version: $FULL_VERSION (npm: $NUMERIC_VERSION)"

      - name: Check if tag already exists
        id: check_tag
        run: |
          if git rev-parse "v${{ steps.version.outputs.full_version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  Tag v${{ steps.version.outputs.full_version }} already exists - skipping release"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Tag v${{ steps.version.outputs.full_version }} does not exist - proceeding with release"
          fi

      - name: Setup Node.js
        if: steps.check_tag.outputs.exists == 'false'
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        if: steps.check_tag.outputs.exists == 'false'
        run: npm ci

      - name: Security audit
        if: steps.check_tag.outputs.exists == 'false'
        run: npm audit --audit-level=low
        continue-on-error: false

      - name: Generate security audit report
        if: failure() && steps.check_tag.outputs.exists == 'false'
        run: npm audit --json > audit-report.json

      - name: Upload security audit report
        if: failure() && steps.check_tag.outputs.exists == 'false'
        uses: actions/upload-artifact@v5
        with:
          name: security-audit-report
          path: audit-report.json
          retention-days: 7

      - name: Run linter
        if: steps.check_tag.outputs.exists == 'false'
        run: npm run lint

      - name: Run unit tests with coverage
        if: steps.check_tag.outputs.exists == 'false'
        run: npm run test:coverage

      - name: Run accessibility unit tests
        if: steps.check_tag.outputs.exists == 'false'
        run: npm run test:a11y

      - name: Upload coverage to Codecov
        if: steps.check_tag.outputs.exists == 'false'
        uses: codecov/codecov-action@v5.5.1
        with:
          files: ./coverage/lcov.info
          flags: unittests
          fail_ci_if_error: false

      - name: Run OWASP Dependency Check
        if: steps.check_tag.outputs.exists == 'false'
        uses: dependency-check/Dependency-Check_Action@main
        id: depcheck
        with:
          project: 'PinballAccuracyMemoryTrainer'
          path: '.'
          format: 'SARIF'
          args: >
            --failOnCVSS 10
            --enableRetired
            --enableExperimental
            --disableNodeAudit
        continue-on-error: true

      - name: Upload OWASP results to GitHub Security
        if: always() && steps.check_tag.outputs.exists == 'false'
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: reports/dependency-check-report.sarif

      - name: Update package.json version temporarily for build
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          npm version ${{ steps.version.outputs.numeric_version }} --no-git-tag-version --allow-same-version

      - name: Build standalone HTML
        if: steps.check_tag.outputs.exists == 'false'
        run: npm run build:standalone
        env:
          BUILD_COMMIT: ${{ steps.version.outputs.commit_hash }}
          BUILD_COMMIT_URL: ${{ github.server_url }}/${{ github.repository }}/commit/${{ steps.version.outputs.commit_hash }}
          BUILD_WORKFLOW_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          RELEASE_URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.full_version }}

      - name: Build for Lighthouse
        if: steps.check_tag.outputs.exists == 'false'
        run: npm run build

      - name: Run Lighthouse CI
        if: steps.check_tag.outputs.exists == 'false'
        env:
          LHCI_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm install -g @lhci/cli@0.13.x
          lhci autorun --config=config/lighthouserc.cjs --upload.github-status-context="Lighthouse CI"

      - name: Upload Playwright report
        if: failure() && steps.check_tag.outputs.exists == 'false'
        uses: actions/upload-artifact@v5
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
          if-no-files-found: ignore

      - name: Create and push tag
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          NEW_VERSION="${{ steps.version.outputs.full_version }}"
          git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION"
          git push origin "v$NEW_VERSION"
          echo "ðŸ·ï¸  Created and pushed tag v$NEW_VERSION"

      - name: Prepare GitHub Pages deployment
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          # Create a temporary directory for GitHub Pages
          mkdir -p gh-pages-deploy

          # Copy standalone build to root (latest version) and rename to index.html
          cp dist-standalone/pinball-trainer-standalone.html gh-pages-deploy/index.html

          # Copy screenshot to root for README display
          cp public/images/app-screenshot.webp gh-pages-deploy/app-screenshot.webp

          # Copy standalone build to versioned release directory (keep original name)
          mkdir -p gh-pages-deploy/releases/${{ steps.version.outputs.full_version }}
          cp -r dist-standalone/* gh-pages-deploy/releases/${{ steps.version.outputs.full_version }}/

          echo "ðŸ“¦ Prepared deployment structure:"
          ls -la gh-pages-deploy/
          echo "ðŸ“¦ Versioned release:"
          ls -la gh-pages-deploy/releases/${{ steps.version.outputs.full_version }}/

      - name: Deploy to GitHub Pages
        if: steps.check_tag.outputs.exists == 'false'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-deploy
          keep_files: true

      - name: Get previous release tag
        if: steps.check_tag.outputs.exists == 'false'
        id: previous_release
        run: |
          # Get the most recent tag before the current one
          PREVIOUS_TAG=$(git tag --sort=-version:refname | head -n 1)
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Previous release tag: $PREVIOUS_TAG"

      - name: Create Release
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2.5.0
        with:
          tag_name: v${{ steps.version.outputs.full_version }}
          name: Release ${{ steps.version.outputs.full_version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          make_latest: true
          files: |
            dist-standalone/pinball-trainer-standalone.html
          body: |
            ## Pinball Accuracy Memory Trainer v${{ steps.version.outputs.full_version }}

            A specialized memory training tool for pinball players to practice and improve flipper shot accuracy recall.

            ### ðŸš€ Try it Online

            **[Launch Latest Version â†’](https://garybrowndev.github.io/PinballAccuracyMemoryTrainer/)**

            **[Launch This Release (v${{ steps.version.outputs.full_version }}) â†’](https://garybrowndev.github.io/PinballAccuracyMemoryTrainer/releases/${{ steps.version.outputs.full_version }}/pinball-trainer-standalone.html)**

            ### ðŸ’¾ Or Download

            Download the standalone HTML file below and open it in your browser. No installation or internet connection required - all assets are embedded.

            ### What's Included

            - 39 preset pinball tables (Addams Family, Medieval Madness, Attack from Mars, and more)
            - Progressive training with drift mechanics
            - Visual playfield editor
            - Performance tracking and feedback
            - Fully offline-capable

            ### Usage

            1. Click the "Launch Latest Version" link above to use the most recent version, OR
            2. Click the "Launch This Release" link to use this specific version, OR
            3. Download `pinball-trainer-standalone.html` below
            4. Open the downloaded file in any modern browser
            5. Start training!
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
