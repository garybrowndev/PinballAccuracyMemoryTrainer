name: 'CD: Release'

on:
  push:
    branches:
      - master

# Prevent multiple concurrent releases - only one at a time
concurrency:
  group: cd-release-${{ github.sha }}
  cancel-in-progress: false

jobs:
  cd-release-build:
    name: 'CD: Build and Test'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      security-events: write
      statuses: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Calculate version from commit count and timestamp
        id: version
        run: |
          # Get commit count on master branch
          COMMIT_COUNT=$(git rev-list --count HEAD)

          # Get timestamp (YYYYMMDD.HHMM format)
          TIMESTAMP=$(date -u +"%Y%m%d.%H%M")

          # Get short commit hash (7 chars) for reference
          SHORT_HASH=$(git rev-parse --short=7 HEAD)

          # Major.Minor.CommitCount.YYYYMMDD.HHMM
          FULL_VERSION="0.0.${COMMIT_COUNT}.${TIMESTAMP}"

          # Numeric version for npm (semver compliant): 0.0.{commit_count}
          NUMERIC_VERSION="0.0.${COMMIT_COUNT}"

          echo "numeric_version=$NUMERIC_VERSION" >> $GITHUB_OUTPUT
          echo "full_version=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "commit_hash=$SHORT_HASH" >> $GITHUB_OUTPUT
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "üì¶ Calculated version: $FULL_VERSION (npm: $NUMERIC_VERSION, commit: $SHORT_HASH)"

      - name: Check if tag already exists
        id: check_tag
        run: |
          if git rev-parse "v${{ steps.version.outputs.full_version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Tag v${{ steps.version.outputs.full_version }} already exists - skipping release"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Tag v${{ steps.version.outputs.full_version }} does not exist - proceeding with release"
          fi

      - name: Setup Node.js
        if: steps.check_tag.outputs.exists == 'false'
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        if: steps.check_tag.outputs.exists == 'false'
        run: npm ci

      - name: Run linter
        if: steps.check_tag.outputs.exists == 'false'
        run: npm run lint

      - name: Run unit tests with coverage
        if: steps.check_tag.outputs.exists == 'false'
        run: npm run test:coverage

      - name: Run accessibility unit tests
        if: steps.check_tag.outputs.exists == 'false'
        run: npm run test:a11y

      - name: Upload coverage to Codecov
        if: steps.check_tag.outputs.exists == 'false'
        uses: codecov/codecov-action@v5.5.1
        with:
          files: ./coverage/lcov.info
          flags: unittests
          fail_ci_if_error: false

      - name: Update package.json version for build
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          npm version ${{ steps.version.outputs.numeric_version }} --no-git-tag-version --allow-same-version

      - name: Build standalone HTML
        if: steps.check_tag.outputs.exists == 'false'
        run: npm run build:standalone
        env:
          BUILD_COMMIT: ${{ steps.version.outputs.commit_hash }}
          BUILD_COMMIT_URL: ${{ github.server_url }}/${{ github.repository }}/commit/${{ steps.version.outputs.commit_hash }}
          BUILD_WORKFLOW_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          RELEASE_URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.full_version }}

      - name: Analyze bundle size
        if: steps.check_tag.outputs.exists == 'false'
        id: analyze
        run: |
          # Get dist folder size
          DIST_SIZE=$(du -sb dist | cut -f1)
          DIST_SIZE_MB=$(echo "scale=2; $DIST_SIZE / 1024 / 1024" | bc)

          # Get main bundle size
          MAIN_BUNDLE=$(find dist/assets -name "index-*.js" -type f -exec du -b {} \; | sort -n | tail -1 | cut -f1)
          MAIN_BUNDLE_KB=$(echo "scale=2; $MAIN_BUNDLE / 1024" | bc)

          # Get CSS bundle size
          CSS_BUNDLE=$(find dist/assets -name "index-*.css" -type f -exec du -b {} \; | sort -n | tail -1 | cut -f1)
          CSS_BUNDLE_KB=$(echo "scale=2; $CSS_BUNDLE / 1024" | bc)

          echo "dist_size_mb=$DIST_SIZE_MB" >> $GITHUB_OUTPUT
          echo "main_bundle_kb=$MAIN_BUNDLE_KB" >> $GITHUB_OUTPUT
          echo "css_bundle_kb=$CSS_BUNDLE_KB" >> $GITHUB_OUTPUT

          # Count files
          ASSET_COUNT=$(find dist/assets -type f | wc -l)
          echo "asset_count=$ASSET_COUNT" >> $GITHUB_OUTPUT

          echo "### Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total dist size | ${DIST_SIZE_MB} MB |" >> $GITHUB_STEP_SUMMARY
          echo "| Main JS bundle | ${MAIN_BUNDLE_KB} KB |" >> $GITHUB_STEP_SUMMARY
          echo "| Main CSS bundle | ${CSS_BUNDLE_KB} KB |" >> $GITHUB_STEP_SUMMARY
          echo "| Total assets | ${ASSET_COUNT} files |" >> $GITHUB_STEP_SUMMARY

      - name: Check bundle size limits
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          MAIN_BUNDLE_KB=${{ steps.analyze.outputs.main_bundle_kb }}
          CSS_BUNDLE_KB=${{ steps.analyze.outputs.css_bundle_kb }}
          DIST_SIZE_MB=${{ steps.analyze.outputs.dist_size_mb }}

          # Warning thresholds (adjusted to realistic values)
          if (( $(echo "$MAIN_BUNDLE_KB > 350" | bc -l) )); then
            echo "‚ö†Ô∏è  Warning: Main JS bundle exceeds 350 KB ($MAIN_BUNDLE_KB KB)"
          fi

          if (( $(echo "$CSS_BUNDLE_KB > 75" | bc -l) )); then
            echo "‚ö†Ô∏è  Warning: CSS bundle exceeds 75 KB ($CSS_BUNDLE_KB KB)"
          fi

          if (( $(echo "$DIST_SIZE_MB > 3" | bc -l) )); then
            echo "‚ö†Ô∏è  Warning: Total dist size exceeds 3 MB ($DIST_SIZE_MB MB)"
          fi

          # Hard limits (fail build)
          if (( $(echo "$MAIN_BUNDLE_KB > 500" | bc -l) )); then
            echo "‚ùå Error: Main JS bundle exceeds hard limit of 500 KB ($MAIN_BUNDLE_KB KB)"
            exit 1
          fi

          if (( $(echo "$DIST_SIZE_MB > 5" | bc -l) )); then
            echo "‚ùå Error: Total dist size exceeds hard limit of 5 MB ($DIST_SIZE_MB MB)"
            exit 1
          fi

          echo "‚úÖ Bundle size within acceptable limits"

      - name: Run Lighthouse CI on standalone build
        if: steps.check_tag.outputs.exists == 'false'
        env:
          LHCI_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm install -g @lhci/cli@0.13.x
          lhci autorun --config=config/lighthouserc.cjs --upload.github-status-context="Lighthouse CI"

      - name: Upload Playwright report
        if: failure() && steps.check_tag.outputs.exists == 'false'
        uses: actions/upload-artifact@v5
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
          if-no-files-found: ignore

      - name: Create and push tag
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          NEW_VERSION="${{ steps.version.outputs.full_version }}"
          git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION"
          git push origin "v$NEW_VERSION"
          echo "üè∑Ô∏è  Created and pushed tag v$NEW_VERSION"

      - name: Prepare GitHub Pages deployment
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          # Create a temporary directory for GitHub Pages
          mkdir -p gh-pages-deploy

          # Copy standalone build to root (latest version) and rename to index.html
          cp dist-standalone/pinball-trainer-standalone.html gh-pages-deploy/index.html

          # Copy screenshot to root for README display
          cp public/images/app-screenshot.webp gh-pages-deploy/app-screenshot.webp

          # Copy standalone build to versioned release directory (keep original name)
          mkdir -p gh-pages-deploy/releases/${{ steps.version.outputs.full_version }}
          cp -r dist-standalone/* gh-pages-deploy/releases/${{ steps.version.outputs.full_version }}/

          echo "üì¶ Prepared deployment structure:"
          ls -la gh-pages-deploy/
          echo "üì¶ Versioned release:"
          ls -la gh-pages-deploy/releases/${{ steps.version.outputs.full_version }}/

      - name: Wait for all other workflows to complete
        if: steps.check_tag.outputs.exists == 'false'
        uses: actions/github-script@v8
        with:
          script: |
            const headSha = context.sha;
            const currentWorkflow = 'CD: Release';
            console.log(`Waiting for all workflows on commit ${headSha} to complete...`);

            const maxAttempts = 60; // 30 minutes max (60 attempts * 30 seconds)
            let attempt = 0;

            while (attempt < maxAttempts) {
              attempt++;
              console.log(`\nüîÑ Attempt ${attempt}/${maxAttempts}`);
              
              // Get all workflow runs for this commit
              const runs = await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head_sha: headSha,
                per_page: 100
              });
              
              // Filter out this workflow and check others
              const otherWorkflows = runs.data.workflow_runs.filter(run => 
                run.name !== currentWorkflow && run.event === 'push'
              );
              
              console.log(`Found ${otherWorkflows.length} other workflows`);
              
              let allComplete = true;
              let allSuccess = true;
              const results = {};
              
              for (const run of otherWorkflows) {
                const status = run.status === 'completed' ? run.conclusion : run.status;
                results[run.name] = status;
                
                if (run.status !== 'completed') {
                  allComplete = false;
                  console.log(`‚è≥ ${run.name}: ${run.status}`);
                } else if (run.conclusion !== 'success') {
                  allSuccess = false;
                  console.log(`‚ùå ${run.name}: ${run.conclusion}`);
                } else {
                  console.log(`‚úÖ ${run.name}: success`);
                }
              }
              
              if (allComplete) {
                console.log('\nüìä All workflows completed!');
                console.log(JSON.stringify(results, null, 2));
                
                if (!allSuccess) {
                  throw new Error('One or more workflows failed. Aborting deployment.');
                }
                
                console.log('\n‚úÖ All workflows succeeded! Proceeding with deployment.');
                break;
              }
              
              if (attempt < maxAttempts) {
                console.log(`\n‚è∞ Waiting 30 seconds before checking again...`);
                await new Promise(resolve => setTimeout(resolve, 30000));
              }
            }

            if (attempt >= maxAttempts) {
              throw new Error('Timeout waiting for workflows to complete after 30 minutes');
            }

      - name: Deploy to GitHub Pages
        if: steps.check_tag.outputs.exists == 'false'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-deploy
          keep_files: true

      - name: Wait for GitHub Pages deployment to propagate
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          echo "‚è≥ Waiting 60 seconds for GitHub Pages to update..."
          sleep 60

      - name: Validate GitHub Pages deployment
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          SITE_URL="https://garybrowndev.github.io/PinballAccuracyMemoryTrainer/"
          echo "üîç Validating deployment at $SITE_URL"

          # Fetch the page
          HTTP_CODE=$(curl -s -o /tmp/gh-pages.html -w "%{http_code}" "$SITE_URL")

          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå ERROR: Site returned HTTP $HTTP_CODE instead of 200"
            exit 1
          fi

          echo "‚úÖ Site returned HTTP 200"

          # Check for actual 404 error page (in title or heading, not in JavaScript code)
          if grep -E "<title>[^<]*404[^<]*</title>" /tmp/gh-pages.html > /dev/null || grep -E "<h[1-6][^>]*>[^<]*404.*Not Found[^<]*</h[1-6]>" /tmp/gh-pages.html > /dev/null; then
            echo "‚ùå ERROR: Page appears to be a 404 error page"
            head -n 50 /tmp/gh-pages.html
            exit 1
          fi

          # Check for external script references that might 404
          EXTERNAL_SCRIPTS=$(grep -o 'src="[^"]*\.js"' /tmp/gh-pages.html || true)
          if [ ! -z "$EXTERNAL_SCRIPTS" ]; then
            echo "‚ö†Ô∏è  WARNING: Found external script references in standalone HTML:"
            echo "$EXTERNAL_SCRIPTS"
            echo "‚ùå ERROR: Standalone build should not have external script references"
            exit 1
          fi

          # Check for external CSS references
          EXTERNAL_CSS=$(grep -o 'href="[^"]*\.css"' /tmp/gh-pages.html || true)
          if [ ! -z "$EXTERNAL_CSS" ]; then
            echo "‚ö†Ô∏è  WARNING: Found external CSS references in standalone HTML:"
            echo "$EXTERNAL_CSS"
            echo "‚ùå ERROR: Standalone build should not have external CSS references"
            exit 1
          fi

          # Check that there's actually some content
          FILE_SIZE=$(wc -c < /tmp/gh-pages.html)
          if [ "$FILE_SIZE" -lt 100000 ]; then
            echo "‚ùå ERROR: Page size is suspiciously small ($FILE_SIZE bytes)"
            echo "Expected at least 100KB for standalone HTML with embedded assets"
            exit 1
          fi

          echo "‚úÖ Page size: $FILE_SIZE bytes"
          echo "‚úÖ No external script/CSS references found"
          echo "‚úÖ GitHub Pages deployment validated successfully!"

      - name: Get previous release tag
        if: steps.check_tag.outputs.exists == 'false'
        id: previous_release
        run: |
          # Get the most recent tag before the current one
          PREVIOUS_TAG=$(git tag --sort=-version:refname | head -n 1)
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          echo "üìã Previous release tag: $PREVIOUS_TAG"

      - name: Create Release
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2.5.0
        with:
          tag_name: v${{ steps.version.outputs.full_version }}
          name: Release ${{ steps.version.outputs.full_version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          make_latest: true
          files: |
            dist-standalone/pinball-trainer-standalone.html
          body: |
            ## Pinball Accuracy Memory Trainer v${{ steps.version.outputs.full_version }}

            A specialized memory training tool for pinball players to practice and improve flipper shot accuracy recall.

            ### üöÄ Try it Online

            **[Launch Latest Version ‚Üí](https://garybrowndev.github.io/PinballAccuracyMemoryTrainer/)**

            **[Launch This Release (v${{ steps.version.outputs.full_version }}) ‚Üí](https://garybrowndev.github.io/PinballAccuracyMemoryTrainer/releases/${{ steps.version.outputs.full_version }}/pinball-trainer-standalone.html)**

            ### üíæ Or Download

            Download the standalone HTML file below and open it in your browser. No installation or internet connection required - all assets are embedded.

            ### What's Included

            - 39 preset pinball tables (Addams Family, Medieval Madness, Attack from Mars, and more)
            - Progressive training with drift mechanics
            - Visual playfield editor
            - Performance tracking and feedback
            - Fully offline-capable

            ### Usage

            1. Click the "Launch Latest Version" link above to use the most recent version, OR
            2. Click the "Launch This Release" link to use this specific version, OR
            3. Download `pinball-trainer-standalone.html` below
            4. Open the downloaded file in any modern browser
            5. Start training!
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
