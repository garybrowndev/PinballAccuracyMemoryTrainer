name: Auto Version and Release

on:
  push:
    branches:
      - master

jobs:
  version-build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Calculate version from run number and commit hash
        id: version
        run: |
          # Get short commit hash (7 chars)
          SHORT_HASH=$(git rev-parse --short=7 HEAD)
          # Numeric version for npm (semver compliant): 0.0.{run_number}
          NUMERIC_VERSION="0.0.${{ github.run_number }}"
          # Full version with commit hash for tag: 0.0.{run_number}.{hash}
          FULL_VERSION="0.0.${{ github.run_number }}.${SHORT_HASH}"
          echo "numeric_version=$NUMERIC_VERSION" >> $GITHUB_OUTPUT
          echo "full_version=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "commit_hash=$SHORT_HASH" >> $GITHUB_OUTPUT
          echo "üì¶ Calculated version: $FULL_VERSION (npm: $NUMERIC_VERSION)"

      - name: Check if tag already exists
        id: check_tag
        run: |
          if git rev-parse "v${{ steps.version.outputs.full_version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Tag v${{ steps.version.outputs.full_version }} already exists - skipping release"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Tag v${{ steps.version.outputs.full_version }} does not exist - proceeding with release"
          fi

      - name: Setup Node.js
        if: steps.check_tag.outputs.exists == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        if: steps.check_tag.outputs.exists == 'false'
        run: npm ci

      - name: Run linter
        if: steps.check_tag.outputs.exists == 'false'
        run: npm run lint

      - name: Run unit tests with coverage
        if: steps.check_tag.outputs.exists == 'false'
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        if: steps.check_tag.outputs.exists == 'false'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: unittests
          fail_ci_if_error: false

      - name: Install Playwright browsers
        if: steps.check_tag.outputs.exists == 'false'
        run: npx playwright install --with-deps

      - name: Run E2E tests
        if: steps.check_tag.outputs.exists == 'false'
        run: npm run test:e2e

      - name: Update package.json version temporarily for build
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          npm version ${{ steps.version.outputs.numeric_version }} --no-git-tag-version --allow-same-version

      - name: Build standalone HTML
        if: steps.check_tag.outputs.exists == 'false'
        run: npm run build:standalone
        env:
          BUILD_COMMIT: ${{ steps.version.outputs.commit_hash }}
          BUILD_COMMIT_URL: ${{ github.server_url }}/${{ github.repository }}/commit/${{ steps.version.outputs.commit_hash }}
          BUILD_WORKFLOW_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Create and push tag
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          NEW_VERSION="${{ steps.version.outputs.full_version }}"
          git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION"
          git push origin "v$NEW_VERSION"
          echo "üè∑Ô∏è  Created and pushed tag v$NEW_VERSION"

      - name: Prepare GitHub Pages deployment
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          # Create a temporary directory for GitHub Pages
          mkdir -p gh-pages-deploy
          
          # Copy standalone build to root (latest version) and rename to index.html
          cp dist-standalone/pinball-trainer-standalone.html gh-pages-deploy/index.html
          
          # Copy screenshot to root for README display
          cp public/images/app-screenshot.jpg gh-pages-deploy/app-screenshot.jpg
          
          # Copy standalone build to versioned release directory (keep original name)
          mkdir -p gh-pages-deploy/releases/${{ steps.version.outputs.full_version }}
          cp -r dist-standalone/* gh-pages-deploy/releases/${{ steps.version.outputs.full_version }}/
          
          echo "üì¶ Prepared deployment structure:"
          ls -la gh-pages-deploy/
          echo "üì¶ Versioned release:"
          ls -la gh-pages-deploy/releases/${{ steps.version.outputs.full_version }}/

      - name: Deploy to GitHub Pages
        if: steps.check_tag.outputs.exists == 'false'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-deploy
          keep_files: true

      - name: Create Release
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.full_version }}
          name: Release ${{ steps.version.outputs.full_version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            dist-standalone/pinball-trainer-standalone.html
          body: |
            ## Pinball Accuracy Memory Trainer v${{ steps.version.outputs.full_version }}
            
            A specialized memory training tool for pinball players to practice and improve flipper shot accuracy recall.
            
            ### üöÄ Try it Online
            
            **[Launch Latest Version ‚Üí](https://garybrowndev.github.io/PinballAccuracyMemoryTrainer/)**
            
            **[Launch This Release (v${{ steps.version.outputs.full_version }}) ‚Üí](https://garybrowndev.github.io/PinballAccuracyMemoryTrainer/releases/${{ steps.version.outputs.full_version }}/pinball-trainer-standalone.html)**
            
            ### üíæ Or Download
            
            Download the standalone HTML file below and open it in your browser. No installation or internet connection required - all assets are embedded.
            
            ### What's Included
            
            - 39 preset pinball tables (Addams Family, Medieval Madness, Attack from Mars, and more)
            - Progressive training with drift mechanics
            - Visual playfield editor
            - Performance tracking and feedback
            - Fully offline-capable
            
            ### Usage
            
            1. Click the "Launch Latest Version" link above to use the most recent version, OR
            2. Click the "Launch This Release" link to use this specific version, OR
            3. Download `pinball-trainer-standalone.html` below
            4. Open the downloaded file in any modern browser
            5. Start training!
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
