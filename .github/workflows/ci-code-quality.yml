name: 'CI: Code Quality'

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  ci-code-quality:
    name: 'CI: Code Quality'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        id: lint
        run: npm run lint
        continue-on-error: true

      - name: Check code formatting
        id: format
        run: npm run format:check
        continue-on-error: true

      - name: Calculate Code Stats
        id: stats
        run: |
          FILES=$(find src tests config -type f \( -name "*.js" -o -name "*.jsx" \) | wc -l)
          LINES=$(find src tests config -type f \( -name "*.js" -o -name "*.jsx" \) -exec cat {} + | wc -l)
          echo "files=$FILES" >> $GITHUB_OUTPUT
          echo "lines=$LINES" >> $GITHUB_OUTPUT

      - name: Generate job summary
        if: always()
        run: |
          {
            echo "## âœ¨ Code Quality Results"
            echo ""
            echo "| Check | Status |"
            echo "|-------|--------|"

            LINT_STATUS="${{ steps.lint.outcome }}"
            FORMAT_STATUS="${{ steps.format.outcome }}"

            if [ "$LINT_STATUS" == "success" ]; then
              echo "| ESLint | âœ… Passed |"
            else
              echo "| ESLint | âŒ Failed |"
            fi

            if [ "$FORMAT_STATUS" == "success" ]; then
              echo "| Prettier | âœ… Passed |"
            else
              echo "| Prettier | âŒ Failed |"
            fi

            echo ""
            echo "### ðŸ“Š Code Statistics"
            echo "| Metric | Count |"
            echo "|--------|-------|"
            echo "| Files  | ${{ steps.stats.outputs.files }} |"
            echo "| Lines  | ${{ steps.stats.outputs.lines }} |"
          } > code_quality_summary.md

          cat code_quality_summary.md >> $GITHUB_STEP_SUMMARY

          if [ "$LINT_STATUS" != "success" ] || [ "$FORMAT_STATUS" != "success" ]; then
            echo "failure=true" >> $GITHUB_OUTPUT
          fi
        id: summary

      - name: Update PR Comment
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const fs = require('fs');
            const updateComment = require('./.github/scripts/update-pr-comment.cjs');

            let body = 'Code Quality check failed or did not run correctly.';
            if (fs.existsSync('code_quality_summary.md')) {
              body = fs.readFileSync('code_quality_summary.md', 'utf8');
              // Remove the header from the body since updateComment adds it
              body = body.replace(/^## .*?\n/, '');
            }

            await updateComment({
              github,
              context,
              header: 'Code Quality Results',
              body,
              workflowYaml: 'ci-code-quality.yml'
            });

      - name: Check failure
        if: steps.summary.outputs.failure == 'true'
        run: exit 1
