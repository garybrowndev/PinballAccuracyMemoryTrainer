name: 'Security: OWASP Dependency Check'

on:
  pull_request:
    branches:
      - master
    types:
      - opened
      - synchronize
      - reopened
  push:
    branches:
      - master
  schedule:
    # Run weekly on Sundays at 3:00 AM UTC
    - cron: '0 3 * * 0'

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  security-owasp-dependency-check:
    name: 'Security: OWASP Dependency Check'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        id: depcheck
        with:
          project: 'PinballAccuracyMemoryTrainer'
          path: '.'
          format: 'SARIF'
          args: >
            --failOnCVSS 0
            --enableRetired
            --enableExperimental
            --disableNodeAudit
            --suppression config/dependency-check-suppression.xml

      - name: Check if SARIF report was generated
        if: always()
        run: |
          if [ -f "reports/dependency-check-report.sarif" ]; then
            echo "âœ… SARIF report found"
            ls -lh reports/dependency-check-report.sarif
          else
            echo "âš ï¸ SARIF report not found at expected location"
            echo "Contents of reports directory:"
            ls -la reports/ || echo "reports directory does not exist"
          fi

      - name: Upload OWASP results to GitHub Security
        if: always() && hashFiles('reports/dependency-check-report.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/dependency-check-report.sarif
          category: dependency-check

      - name: Generate job summary
        if: always()
        run: |
          python3 -c '
          import json
          import os

          print("## ðŸ›¡ï¸ OWASP Dependency Check Results")

          report_path = "reports/dependency-check-report.sarif"
          if os.path.exists(report_path):
              try:
                  with open(report_path, "r", encoding="utf-8") as f:
                      data = json.load(f)
                      runs = data.get("runs", [])
                      total_vulns = 0
                      for run in runs:
                          results = run.get("results", [])
                          total_vulns += len(results)
                      
                      if total_vulns == 0:
                          print("\nâœ… No vulnerabilities found.")
                      else:
                          print(f"\nâš ï¸ Found {total_vulns} vulnerabilities.")
                          print("\nCheck the [Security tab](../../security/code-scanning) for details.")
              except Exception as e:
                  print(f"Error parsing report: {e}")
          else:
              print("Report file not found.")
          ' >> $GITHUB_STEP_SUMMARY
