name: 'Security: OWASP Dependency Check'

on:
  pull_request:
    branches:
      - master
    types:
      - opened
      - synchronize
      - reopened
  push:
    branches:
      - master
  schedule:
    # Run weekly on Sundays at 3:00 AM UTC
    - cron: '0 3 * * 0'

permissions:
  contents: read

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  security-owasp-dependency-check:
    name: 'Security: OWASP Dependency Check'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@1e54355a8b4c8abaa8cc7d0b70aa655a3bb15a6c # main
        id: depcheck
        with:
          project: 'PinballAccuracyMemoryTrainer'
          path: '.'
          format: 'SARIF'
          args: >
            --failOnCVSS 0
            --enableRetired
            --enableExperimental
            --disableNodeAudit
            --suppression config/dependency-check-suppression.xml

      - name: Check if SARIF report was generated
        if: always()
        run: |
          if [ -f "reports/dependency-check-report.sarif" ]; then
            echo "‚úÖ SARIF report found"
            ls -lh reports/dependency-check-report.sarif
          else
            echo "‚ö†Ô∏è SARIF report not found at expected location"
            echo "Contents of reports directory:"
            ls -la reports/ || echo "reports directory does not exist"
          fi

      - name: Upload OWASP results to GitHub Security
        if: always() && hashFiles('reports/dependency-check-report.sarif') != ''
        uses: github/codeql-action/upload-sarif@19b2f06db2b6f5108140aeb04014ef02b648f789 # v4.31.11
        with:
          sarif_file: reports/dependency-check-report.sarif
          category: dependency-check

      - name: Upload OWASP report artifact
        if: always() && hashFiles('reports/dependency-check-report.sarif') != ''
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: dependency-check-report
          path: reports/dependency-check-report.sarif

      - name: Generate job summary
        if: always()
        run: |
          cat <<EOF > owasp_summary.py
          import json
          import os

          print("## üõ°Ô∏è OWASP Dependency Check Results")

          report_path = "reports/dependency-check-report.sarif"
          if os.path.exists(report_path):
              try:
                  with open(report_path, "r", encoding="utf-8") as f:
                      data = json.load(f)
                      runs = data.get("runs", [])
                      total_vulns = 0
                      by_severity = {"error": 0, "warning": 0, "note": 0, "other": 0}
                      all_results = []

                      for run in runs:
                          results = run.get("results", [])
                          total_vulns += len(results)
                          for res in results:
                              level = res.get("level", "warning")
                              if level not in by_severity:
                                  by_severity["other"] += 1
                              else:
                                  by_severity[level] += 1
                              
                              rule_id = res.get("ruleId", "N/A")
                              msg = res.get("message", {}).get("text", "N/A")
                              if len(msg) > 100:
                                  msg = msg[:97] + "..."
                              
                              all_results.append(f"| {rule_id} | {msg} |")
                      
                      print(f"\n**Total Vulnerabilities:** {total_vulns}")
                      
                      print("\n### Severity Breakdown")
                      print("| Severity | Count |")
                      print("| --- | --- |")
                      print(f"| üî¥ High/Critical | {by_severity['error']} |")
                      print(f"| ‚ö†Ô∏è Medium | {by_severity['warning']} |")
                      print(f"| ‚ÑπÔ∏è Low | {by_severity['note']} |")

                      if total_vulns > 0:
                          print("\n### Detailed Findings")
                          print("| Rule | Message |")
                          print("| --- | --- |")
                          for row in all_results[:20]:
                              print(row)
                          if len(all_results) > 20:
                              print(f"| ... | ... ({len(all_results) - 20} more) |")
                          
                          print("\nCheck the [Security tab](../../security/code-scanning) for full details.")
                      else:
                          print("\n‚úÖ No vulnerabilities found.")
              except Exception as e:
                  print(f"Error parsing report: {e}")
          else:
              print("Report file not found.")
          EOF

          python3 owasp_summary.py > owasp_summary.md
          cat owasp_summary.md >> $GITHUB_STEP_SUMMARY

      - name: Update PR Comment
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const fs = require('fs');
            const updateComment = require('./.github/scripts/update-pr-comment.cjs');

            let body = 'OWASP Dependency Check failed or did not run correctly.';
            if (fs.existsSync('owasp_summary.md')) {
              body = fs.readFileSync('owasp_summary.md', 'utf8');
              // Remove the header from the body since updateComment adds it
              body = body.replace(/^## .*?\n/, '');
            }

            await updateComment({
              github,
              context,
              header: 'OWASP Dependency Check',
              body,
              workflowYaml: 'security-owasp-dependency-check.yml'
            });
