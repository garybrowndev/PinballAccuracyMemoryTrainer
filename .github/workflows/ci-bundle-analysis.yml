name: 'CI: Bundle Analysis'

on:
  pull_request:
    branches:
      - master
    types:
      - opened
      - synchronize
      - reopened
  push:
    branches:
      - master

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  ci-bundle-analysis:
    name: 'CI: Bundle Analysis'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build dist for bundle size analysis
        run: npm run build

      - name: Analyze bundle size
        id: analyze
        run: |
          # Get dist folder size
          DIST_SIZE=$(du -sb dist | cut -f1)
          DIST_SIZE_MB=$(echo "scale=2; $DIST_SIZE / 1024 / 1024" | bc)

          # Get main bundle size
          MAIN_BUNDLE=$(find dist/assets -name "index-*.js" -type f -exec du -b {} \; | sort -n | tail -1 | cut -f1)
          MAIN_BUNDLE_KB=$(echo "scale=2; $MAIN_BUNDLE / 1024" | bc)

          # Get CSS bundle size
          CSS_BUNDLE=$(find dist/assets -name "index-*.css" -type f -exec du -b {} \; | sort -n | tail -1 | cut -f1)
          CSS_BUNDLE_KB=$(echo "scale=2; $CSS_BUNDLE / 1024" | bc)

          echo "dist_size_mb=$DIST_SIZE_MB" >> $GITHUB_OUTPUT
          echo "main_bundle_kb=$MAIN_BUNDLE_KB" >> $GITHUB_OUTPUT
          echo "css_bundle_kb=$CSS_BUNDLE_KB" >> $GITHUB_OUTPUT

          # Count files
          ASSET_COUNT=$(find dist/assets -type f | wc -l)
          echo "asset_count=$ASSET_COUNT" >> $GITHUB_OUTPUT

          echo "### Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total dist size | ${DIST_SIZE_MB} MB |" >> $GITHUB_STEP_SUMMARY
          echo "| Main JS bundle | ${MAIN_BUNDLE_KB} KB |" >> $GITHUB_STEP_SUMMARY
          echo "| Main CSS bundle | ${CSS_BUNDLE_KB} KB |" >> $GITHUB_STEP_SUMMARY
          echo "| Total assets | ${ASSET_COUNT} files |" >> $GITHUB_STEP_SUMMARY

      - name: Post bundle size report to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const updateComment = require('./.github/scripts/update-pr-comment.cjs');
            const distSize = '${{ steps.analyze.outputs.dist_size_mb }}';
            const mainBundle = '${{ steps.analyze.outputs.main_bundle_kb }}';
            const cssBundle = '${{ steps.analyze.outputs.css_bundle_kb }}';
            const assetCount = '${{ steps.analyze.outputs.asset_count }}';

            const comment = `
            | Metric | Size |
            |--------|------|
            | Total dist size | ${distSize} MB |
            | Main JS bundle | ${mainBundle} KB |
            | Main CSS bundle | ${cssBundle} KB |
            | Total assets | ${assetCount} files |

            ### Recommendations
            - ðŸŽ¯ Keep main JS bundle under 200 KB for optimal performance
            - ðŸŽ¨ Keep CSS bundle under 50 KB
            - ðŸ“ Keep total dist size under 2 MB

            *Bundle analysis completed at ${new Date().toISOString()}*`;

            await updateComment({
              github,
              context,
              header: 'Bundle Size Report',
              body: comment,
              workflowYaml: 'ci-bundle-analysis.yml'
            });

      - name: Check bundle size limits
        run: |
          MAIN_BUNDLE_KB=${{ steps.analyze.outputs.main_bundle_kb }}
          CSS_BUNDLE_KB=${{ steps.analyze.outputs.css_bundle_kb }}
          DIST_SIZE_MB=${{ steps.analyze.outputs.dist_size_mb }}

          # Warning thresholds (adjusted to realistic values)
          if (( $(echo "$MAIN_BUNDLE_KB > 350" | bc -l) )); then
            echo "âš ï¸  Warning: Main JS bundle exceeds 350 KB ($MAIN_BUNDLE_KB KB)"
          fi

          if (( $(echo "$CSS_BUNDLE_KB > 75" | bc -l) )); then
            echo "âš ï¸  Warning: CSS bundle exceeds 75 KB ($CSS_BUNDLE_KB KB)"
          fi

          if (( $(echo "$DIST_SIZE_MB > 3" | bc -l) )); then
            echo "âš ï¸  Warning: Total dist size exceeds 3 MB ($DIST_SIZE_MB MB)"
          fi

          # Hard limits (fail build)
          if (( $(echo "$MAIN_BUNDLE_KB > 500" | bc -l) )); then
            echo "âŒ Error: Main JS bundle exceeds hard limit of 500 KB ($MAIN_BUNDLE_KB KB)"
            exit 1
          fi

          if (( $(echo "$DIST_SIZE_MB > 5" | bc -l) )); then
            echo "âŒ Error: Total dist size exceeds hard limit of 5 MB ($DIST_SIZE_MB MB)"
            exit 1
          fi

          echo "âœ… Bundle size within acceptable limits"

      - name: Add bundle analysis summary
        if: always()
        run: |
          MAIN_BUNDLE_KB=${{ steps.analyze.outputs.main_bundle_kb }}
          CSS_BUNDLE_KB=${{ steps.analyze.outputs.css_bundle_kb }}
          DIST_SIZE_MB=${{ steps.analyze.outputs.dist_size_mb }}
          ASSET_COUNT=${{ steps.analyze.outputs.asset_count }}

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Bundle Size Limits Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Current | Warning | Hard Limit | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|---------|---------|------------|--------|" >> $GITHUB_STEP_SUMMARY

          # Main JS bundle
          if (( $(echo "$MAIN_BUNDLE_KB > 500" | bc -l) )); then
            echo "| Main JS bundle | ${MAIN_BUNDLE_KB} KB | 350 KB | 500 KB | âŒ **FAIL** |" >> $GITHUB_STEP_SUMMARY
          elif (( $(echo "$MAIN_BUNDLE_KB > 350" | bc -l) )); then
            echo "| Main JS bundle | ${MAIN_BUNDLE_KB} KB | 350 KB | 500 KB | âš ï¸ Warning |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Main JS bundle | ${MAIN_BUNDLE_KB} KB | 350 KB | 500 KB | âœ… Pass |" >> $GITHUB_STEP_SUMMARY
          fi

          # CSS bundle
          if (( $(echo "$CSS_BUNDLE_KB > 75" | bc -l) )); then
            echo "| CSS bundle | ${CSS_BUNDLE_KB} KB | 75 KB | N/A | âš ï¸ Warning |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| CSS bundle | ${CSS_BUNDLE_KB} KB | 75 KB | N/A | âœ… Pass |" >> $GITHUB_STEP_SUMMARY
          fi

          # Total dist size
          if (( $(echo "$DIST_SIZE_MB > 5" | bc -l) )); then
            echo "| Total dist size | ${DIST_SIZE_MB} MB | 3 MB | 5 MB | âŒ **FAIL** |" >> $GITHUB_STEP_SUMMARY
          elif (( $(echo "$DIST_SIZE_MB > 3" | bc -l) )); then
            echo "| Total dist size | ${DIST_SIZE_MB} MB | 3 MB | 5 MB | âš ï¸ Warning |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Total dist size | ${DIST_SIZE_MB} MB | 3 MB | 5 MB | âœ… Pass |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload dist artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: dist-bundle
          path: dist/
