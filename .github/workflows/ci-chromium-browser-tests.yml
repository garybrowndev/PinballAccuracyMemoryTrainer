name: 'CI: Chromium Browser Tests'

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  ci-chromium-browser-tests:
    name: 'CI: Chromium Browser Tests'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Chromium
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests on Chromium
        run: npx playwright test --project=chromium --config config/playwright.config.js --grep-invert "Visual Regression" --reporter=list,json,html
        env:
          PLAYWRIGHT_JSON_OUTPUT_FILE: results-chromium.json

      - name: Run accessibility E2E tests on Chromium
        run: npx playwright test --project=chromium --config config/playwright.config.js tests/e2e/accessibility.spec.js --reporter=list,json,html
        env:
          PLAYWRIGHT_JSON_OUTPUT_FILE: results-a11y.json

      - name: Generate job summary
        if: always()
        run: |
          python3 -c '
          import json
          import os

          def parse_json_report(file_path, title):
              if not os.path.exists(file_path):
                  return f"| {title} | âš ï¸ Not Found | - | - | - | - |"
              
              try:
                  with open(file_path, "r") as f:
                      data = json.load(f)
                  
                  stats = data.get("stats", {})
                  total = stats.get("expected", 0) + stats.get("unexpected", 0) + stats.get("flaky", 0) + stats.get("skipped", 0)
                  passed = stats.get("expected", 0)
                  failed = stats.get("unexpected", 0)
                  flaky = stats.get("flaky", 0)
                  skipped = stats.get("skipped", 0)
                  duration = round(stats.get("duration", 0) / 1000, 2)
                  
                  status = "âœ… PASS" if failed == 0 else "âŒ FAIL"
                  return f"| {title} | {status} | {total} | {passed} | {failed} | {duration}s |"
              except Exception as e:
                  return f"| {title} | âš ï¸ Error parsing | - | - | - | - |"

          print("## ðŸŽ­ Chromium Browser Test Results")
          print("| Suite | Status | Total | Passed | Failed | Time |")
          print("|-------|--------|-------|--------|--------|------|")
          print(parse_json_report("results-chromium.json", "E2E Tests"))
          print(parse_json_report("results-a11y.json", "Accessibility Tests"))
          ' >> $GITHUB_STEP_SUMMARY

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: playwright-results-chromium
          path: |
            playwright-report/
            test-results/
          if-no-files-found: ignore
