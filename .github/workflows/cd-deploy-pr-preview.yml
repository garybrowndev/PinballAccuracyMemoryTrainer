name: 'CD: Deploy PR Preview'

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - master

permissions:
  contents: read

# Cancel in-progress runs for the same PR
concurrency:
  group: pr-preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  cd-deploy-pr-preview:
    name: 'CD: Deploy PR Preview'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build standalone HTML
        run: npm run build:standalone

      - name: Prepare deployment directory
        run: |
          # Create deployment directory and copy standalone build as index.html
          mkdir -p deploy
          cp dist-standalone/pinball-trainer-standalone.html deploy/index.html

      - name: Deploy to Surge.sh (Preview)
        id: deploy
        run: |
          # Generate unique preview URL
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PREVIEW_URL="pinball-trainer-pr-${PR_NUMBER}.surge.sh"

          # Deploy to surge using npx with pinned version (avoids global install)
          npx surge@0.24.6 ./deploy $PREVIEW_URL --token ${{ secrets.SURGE_TOKEN }}

          echo "preview_url=https://$PREVIEW_URL" >> $GITHUB_OUTPUT

      - name: Check Surge.sh service availability
        id: surge-status
        if: steps.deploy.outcome == 'success'
        continue-on-error: true
        run: |
          echo "üîç Checking if Surge.sh is accessible..."

          # Check if surge.sh main site responds
          if timeout 10 curl -sf https://surge.sh > /dev/null 2>&1; then
            echo "‚úÖ Surge.sh is accessible"
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  WARNING: Surge.sh appears to be down or inaccessible"
            echo "available=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Wait for Surge deployment to propagate
        if: steps.deploy.outcome == 'success' && steps.surge-status.outputs.available == 'true'
        run: |
          echo "‚è≥ Waiting 60 seconds for Surge deployment to propagate..."
          sleep 60

      - name: Validate Surge deployment
        if: steps.deploy.outcome == 'success' && steps.surge-status.outputs.available == 'true'
        run: |
          SITE_URL="${{ steps.deploy.outputs.preview_url }}"
          echo "üîç Validating deployment at $SITE_URL"

          # Fetch the page
          HTTP_CODE=$(curl -s -o /tmp/surge-deploy.html -w "%{http_code}" "$SITE_URL")

          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå ERROR: Site returned HTTP $HTTP_CODE instead of 200"
            exit 1
          fi

          echo "‚úÖ Site returned HTTP 200"

          # Check for actual 404 error page (in title or heading, not in JavaScript code)
          if grep -E "<title>[^<]*404[^<]*</title>" /tmp/surge-deploy.html > /dev/null || grep -E "<h[1-6][^>]*>[^<]*404.*Not Found[^<]*</h[1-6]>" /tmp/surge-deploy.html > /dev/null; then
            echo "‚ùå ERROR: Page appears to be a 404 error page"
            head -n 50 /tmp/surge-deploy.html
            exit 1
          fi

          # Check for external script references that might 404
          EXTERNAL_SCRIPTS=$(grep -o 'src="[^"]*\.js"' /tmp/surge-deploy.html || true)
          if [ ! -z "$EXTERNAL_SCRIPTS" ]; then
            echo "‚ö†Ô∏è  WARNING: Found external script references in standalone HTML:"
            echo "$EXTERNAL_SCRIPTS"
            echo "‚ùå ERROR: Standalone build should not have external script references"
            exit 1
          fi

          # Check for external CSS references
          EXTERNAL_CSS=$(grep -o 'href="[^"]*\.css"' /tmp/surge-deploy.html || true)
          if [ ! -z "$EXTERNAL_CSS" ]; then
            echo "‚ö†Ô∏è  WARNING: Found external CSS references in standalone HTML:"
            echo "$EXTERNAL_CSS"
            echo "‚ùå ERROR: Standalone build should not have external CSS references"
            exit 1
          fi

          # Check that there's actually some content
          FILE_SIZE=$(wc -c < /tmp/surge-deploy.html)
          if [ "$FILE_SIZE" -lt 100000 ]; then
            echo "‚ùå ERROR: Page size is suspiciously small ($FILE_SIZE bytes)"
            echo "Expected at least 100KB for standalone HTML with embedded assets"
            exit 1
          fi

          echo "‚úÖ Page size: $FILE_SIZE bytes"
          echo "‚úÖ No external script/CSS references found"
          echo "‚úÖ Surge deployment validated successfully!"

      - name: Report service unavailability
        if: steps.deploy.outcome == 'success' && steps.surge-status.outcome == 'failure'
        run: |
          echo "‚ö†Ô∏è  WARNING: Surge.sh service appears to be unavailable"
          echo "üì¶ Deployment was published, but validation was skipped"
          echo "üîó Preview URL: ${{ steps.deploy.outputs.preview_url }}"
          echo ""
          echo "This is not a failure of the deployment process."
          echo "The site may become accessible once Surge.sh service is restored."
          echo ""
          echo "::warning title=Surge.sh Validation Skipped::Surge.sh service is currently unavailable. Deployment succeeded but could not be validated. Manual verification recommended."

      - name: Comment on PR with validation status
        if: steps.deploy.outcome == 'success' && steps.surge-status.outcome == 'failure'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '### ‚ö†Ô∏è Surge.sh Validation Skipped\n\nDeployment succeeded but validation was skipped because Surge.sh is currently unavailable.\n\n**Recommendation**: Manually verify the deployment when the service is back online.'
            })

      - name: Add label for skipped validation
        if: steps.deploy.outcome == 'success' && steps.surge-status.outcome == 'failure'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['surge-validation-skipped']
              })
            } catch (error) {
              console.log('Could not add label, possibly due to permissions or label missing. Continuing.')
            }

      - name: Comment preview URL on PR
        if: steps.deploy.outcome == 'success'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const updateComment = require('./.github/scripts/update-pr-comment.cjs');
            const previewUrl = '${{ steps.deploy.outputs.preview_url }}';
            const surgeAvailable = '${{ steps.surge-status.outputs.available }}' === 'true';

            let comment;
            if (surgeAvailable) {
              comment = `Your preview deployment is ready!

            üîó **Preview URL:** ${previewUrl}

            ### What's included:
            - ‚úÖ Standalone HTML build (same as production)
            - ‚úÖ All assets embedded inline
            - ‚úÖ Fully offline-capable
            - ‚úÖ Production optimizations

            ### Testing checklist:
            - [ ] Test dark mode toggle
            - [ ] Test preset loading
            - [ ] Test practice mode
            - [ ] Test recall mode
            - [ ] Test PWA install prompt
            - [ ] Test offline functionality

            *Preview will be updated on each new commit to this PR.*

            ---
            *Deployed at ${new Date().toISOString()}*`;
            } else {
              comment = `‚ö†Ô∏è  **Preview deployment completed with service unavailability**

            üîó **Preview URL:** ${previewUrl}

            ### ‚ö†Ô∏è  Notice:
            Surge.sh appears to be experiencing service issues. The deployment was successful, but validation was skipped.

            The preview may become accessible once Surge.sh service is restored. You can try accessing the URL periodically to check if the service has recovered.

            ### What was deployed:
            - ‚úÖ Standalone HTML build (same as production)
            - ‚úÖ All assets embedded inline
            - ‚úÖ Fully offline-capable
            - ‚úÖ Production optimizations

            *Preview will be updated on each new commit to this PR.*

            ---
            *Deployed at ${new Date().toISOString()}*

            > üí° **Note**: This is not a failure of the deployment process or your PR. This status check will not block merging.`;
            }

            await updateComment({
              github,
              context,
              header: 'Preview Deployment',
              body: comment,
              workflowYaml: 'cd-deploy-pr-preview.yml'
            });

      - name: Comment if deployment failed
        if: steps.deploy.outcome == 'failure'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const updateComment = require('./.github/scripts/update-pr-comment.cjs');
            const comment = `The preview deployment could not be completed. This might be due to:
            - Missing SURGE_TOKEN secret
            - Build errors
            - Network issues

            Please check the workflow logs for details.`;

            await updateComment({
              github,
              context,
              header: 'Preview Deployment (Failed)',
              body: comment,
              workflowYaml: 'cd-deploy-pr-preview.yml'
            });

      - name: Generate job summary
        if: always()
        run: |
          echo "## üöÄ Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          DEPLOY_STATUS="${{ steps.deploy.outcome }}"
          PREVIEW_URL="${{ steps.deploy.outputs.preview_url }}"

          if [ "$DEPLOY_STATUS" == "success" ]; then
            echo "‚úÖ **Deployed Successfully**" >> $GITHUB_STEP_SUMMARY
            echo "üîó [Open Preview]($PREVIEW_URL)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Deployment Failed**" >> $GITHUB_STEP_SUMMARY
          fi
