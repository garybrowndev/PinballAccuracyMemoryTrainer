name: 'Security: CodeQL Security Analysis'

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  schedule:
    # Run weekly on Sundays at 2:00 AM UTC
    - cron: '0 2 * * 0'

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  security-codeql-security-analysis:
    name: 'Security: CodeQL Security Analysis'
    runs-on: ubuntu-latest

    permissions:
      security-events: write
      contents: read
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript
          # Use security-and-quality queries for maximum comprehensive analysis
          queries: security-and-quality

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: '/language:javascript-typescript'
          output: codeql-results

      - name: Generate CodeQL Summary
        if: always()
        run: |
          python3 -c '
          import json
          import os
          import glob

          print("## ðŸ›¡ï¸ CodeQL Security Analysis Results")

          files = glob.glob("codeql-results/**/*.sarif", recursive=True)

          if not files:
              print("No SARIF files found.")
          else:
              total_alerts = 0
              
              for f in files:
                  try:
                      with open(f, "r", encoding="utf-8") as json_file:
                          data = json.load(json_file)
                          runs = data.get("runs", [])
                          for run in runs:
                              results = run.get("results", [])
                              total_alerts += len(results)
                  except Exception as e:
                      pass
              
              if total_alerts == 0:
                  print("\nâœ… No security alerts found.")
              else:
                  print(f"\nâš ï¸ Found {total_alerts} alerts. Check the [Security tab](../../security/code-scanning) for details.")
          ' >> $GITHUB_STEP_SUMMARY

          # Find the SARIF file
          SARIF_FILE=$(find codeql-results -name "*.sarif" | head -n 1)

          if [ -f "$SARIF_FILE" ]; then
            # Get total count
            COUNT=$(jq '.runs[].results | length' "$SARIF_FILE")
            echo "### Total Alerts: $COUNT" >> $GITHUB_STEP_SUMMARY
            
            if [ "$COUNT" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Rule | Message | Location |" >> $GITHUB_STEP_SUMMARY
              echo "| --- | --- | --- |" >> $GITHUB_STEP_SUMMARY
              
              # Generate table rows
              jq -r '.runs[].results[] | "| \(.ruleId) | \(.message.text) | \(.locations[0].physicalLocation.artifactLocation.uri):\(.locations[0].physicalLocation.region.startLine) |"' "$SARIF_FILE" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… No security alerts found." >> $GITHUB_STEP_SUMMARY
            fi
            
            # Also print to console for logs
            echo "Detailed Findings:"
            jq -r '.runs[].results[] | "Rule: \(.ruleId)\nMessage: \(.message.text)\nLocation: \(.locations[0].physicalLocation.artifactLocation.uri):\(.locations[0].physicalLocation.region.startLine)\n-------------------"' "$SARIF_FILE"
          else
            echo "âŒ SARIF file not found." >> $GITHUB_STEP_SUMMARY
          fi
