name: 'Security: CodeQL Security Analysis'

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  schedule:
    # Run weekly on Sundays at 2:00 AM UTC
    - cron: '0 2 * * 0'

permissions:
  contents: read

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  security-codeql-security-analysis:
    name: 'Security: CodeQL Security Analysis'
    runs-on: ubuntu-latest

    permissions:
      security-events: write
      contents: read
      actions: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Initialize CodeQL
        uses: github/codeql-action/init@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4.32.2
        with:
          languages: javascript-typescript
          # Use security-and-quality queries for maximum comprehensive analysis
          queries: security-and-quality

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4.32.2
        with:
          category: '/language:javascript-typescript'
          output: codeql-results

      - name: Generate CodeQL Summary
        if: always()
        run: |
          cat <<EOF > codeql_summary.py
          import json
          import os
          import glob

          print("## ðŸ›¡ï¸ CodeQL Security Analysis Results")

          files = glob.glob("codeql-results/**/*.sarif", recursive=True)

          if not files:
              print("No SARIF files found.")
          else:
              total_alerts = 0
              by_severity = {"error": 0, "warning": 0, "note": 0, "other": 0}
              all_results = []

              for f in files:
                  try:
                      with open(f, "r", encoding="utf-8") as json_file:
                          data = json.load(json_file)
                          runs = data.get("runs", [])
                          for run in runs:
                              results = run.get("results", [])
                              total_alerts += len(results)
                              for res in results:
                                  level = res.get("level", "warning")
                                  if level not in by_severity:
                                      by_severity["other"] += 1
                                  else:
                                      by_severity[level] += 1
                                  
                                  rule_id = res.get("ruleId", "N/A")
                                  msg = res.get("message", {}).get("text", "N/A")
                                  locs = res.get("locations", [])
                                  if locs:
                                      ploc = locs[0].get("physicalLocation", {})
                                      uri = ploc.get("artifactLocation", {}).get("uri", "unknown")
                                      line = ploc.get("region", {}).get("startLine", 0)
                                      location = f"{uri}:{line}"
                                  else:
                                      location = "N/A"
                                  
                                  all_results.append(f"| {rule_id} | {msg} | {location} |")

                  except Exception as e:
                      print(f"Error parsing {f}: {e}")

              print(f"\n**Total Alerts:** {total_alerts}")
              
              print("\n### Severity Breakdown")
              print("| Severity | Count |")
              print("| --- | --- |")
              print(f"| ðŸ”´ Error | {by_severity['error']} |")
              print(f"| âš ï¸ Warning | {by_severity['warning']} |")
              print(f"| â„¹ï¸ Note | {by_severity['note']} |")

              if total_alerts > 0:
                  print("\n### Detailed Findings")
                  print("| Rule | Message | Location |")
                  print("| --- | --- | --- |")
                  for row in all_results[:20]:
                      print(row)
                  if len(all_results) > 20:
                      print(f"| ... | ... ({len(all_results) - 20} more) | ... |")
              else:
                  print("\nâœ… No security alerts found.")
          EOF

          python3 codeql_summary.py > codeql_summary.md
          cat codeql_summary.md >> $GITHUB_STEP_SUMMARY

      - name: Update PR Comment
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const fs = require('fs');
            const updateComment = require('./.github/scripts/update-pr-comment.cjs');

            let body = 'CodeQL Analysis failed or did not run correctly.';
            if (fs.existsSync('codeql_summary.md')) {
              body = fs.readFileSync('codeql_summary.md', 'utf8');
              // Remove the header from the body since updateComment adds it
              body = body.replace(/^## .*?\n/, '');
            }

            await updateComment({
              github,
              context,
              header: 'CodeQL Security Analysis',
              body,
              workflowYaml: 'security-codeql-security-analysis.yml'
            });

      - name: Upload CodeQL results artifact
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: codeql-results
          path: codeql-results/
